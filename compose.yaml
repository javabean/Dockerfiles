#%YAML 1.2
---
# https://docs.docker.com/compose/compose-file/
# https://hub.docker.com/explore/

#version: 2023-05-16  # deprecated

x-base-service: &base-service
  labels:
    - "traefik.enable=false"
  #expose:
    ## Consul agent ports
    #- "8301"
    #- "8301/udp"
    ##- "8400"
    ##- "8500"
  environment:
    # please note that SYSLOG requires read_only: false (as it needs creating /dev/log) for Docker < 17.12.0
    #- ENABLE_SYSLOG=1
    #- ENABLE_CRON=1
    #- ENABLE_CONSUL=1
    # Force PHP/Symfony, NodeJS, Ruby on Rails & Elixir applications to production
    - APP_ENV=prod
    - APP_DEBUG=0
    - NODE_ENV=production
    - RAILS_ENV=production
    - MIX_ENV=prod
    - JDK_JAVA_OPTIONS="-Djdk.disableLastUsageTracking"
    - JAVA_TOOL_OPTIONS="-Djava.net.useSystemProxies=true -Djava.awt.headless=true"
    - DOTNET_CLI_TELEMETRY_OPTOUT=1
    # https://servicebinding.io/
    #- SERVICE_BINDING_ROOT=/run/secrets
  tmpfs:
    # default tmpfs opts: rw,nosuid,nodev,noexec,relatime,size=65536k
    - /run:rw,nosuid,noexec,relatime,size=65536k,mode=755
    - /run/lock:rw,nosuid,nodev,noexec,relatime,size=5120k,mode=1777
    #- /var/log
    #- /var/cache
    #- /var/tmp
    - /tmp:rw,nosuid,nodev,noexec,size=131072k,mode=1777,strictatime
    # required for syslog
    #- /var/lib/syslog-ng:rw,nosuid,nodev,noexec,relatime,size=16k
    # required for logrotate
    - /var/lib/logrotate:rw,nosuid,nodev,noexec,relatime,size=16k
    # mount work dir for runit
    - /var/lib/runit-sv:rw,suid,nodev,exec,size=1024k
    # mount work dir for consul
    #- /usr/local/etc/consul.d:rw,nosuid,nodev,noexec,size=128k
  #shm_size: 64M
  logging:
    driver: "json-file"
    options:
      max-size: "5m"
      max-file: "2"
      compress: "true"
  cpu_shares: 1024
  mem_swappiness: 1
  memswap_limit: 192m
  deploy:
    resources:
      limits:
        cpus: '1.0'  # number of cores
        memory: 128m
      reservations:
        cpus: '0.05'  # number of cores
        #memory: 128m
    restart_policy:
      condition: unless-stopped # no, on-failure[:max-retries], always, unless-stopped (default: no)
      delay: 5s  # (default: 0)
      #max_attempts: 3  # (default: never give up)
      window: 30s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
  read_only: true

x-base-php-service: &base-php-service
  #extends:
  #  service: base-service
  <<: *base-service
  init: true
  expose:
    - "80"
  #environment:
    #- ENABLE_CRON=1
  depends_on:
    newrelic-php-daemon:
      condition: service_healthy
  tmpfs:
    # PHP.ini 'session.save_path'
    - /var/lib/php/sessions:rw,nosuid,nodev,noexec,relatime,size=65536k,mode=1733

########################################################################

services:

  # to configure backends: https://docs.traefik.io/providers/docker/
  traefik:
    <<: *base-service
    image: traefik:${TRAEFIK_VERSION:-2.10}
    init: true
    # https://docs.traefik.io/v2.10/reference/dynamic-configuration/docker/
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=default"
      - "traefik.http.routers.traefik-http.rule=Host(`traefik.docker.localhost`) && PathPrefix(`/api`,`/dashboard`)"
      - "traefik.http.routers.traefik-http.entrypoints=http"
      - "traefik.http.routers.traefik-http.middlewares=403"
      - "traefik.http.routers.traefik-http.service=api@internal"
      - "traefik.http.routers.traefik-https.rule=Host(`traefik.docker.localhost`) && PathPrefix(`/api`,`/dashboard`)"
      - "traefik.http.routers.traefik-https.entrypoints=https"
      - "traefik.http.routers.traefik-https.middlewares=std-ipwhitelist,traefik-authentication,defaultchain-https"
      - "traefik.http.routers.traefik-https.service=api@internal"
      # Note: If a TLS section (i.e. any of its fields) is user-defined, then the default configuration does not apply at all.
#      - "traefik.http.routers.traefik-https.tls=true"
#      - "traefik.http.routers.traefik-https.tls.certresolver=letsencrypt"
#      - "traefik.http.routers.traefik-https.tls.options=default"
      #- "traefik.http.routers.traefik-https.priority=42"
      - "traefik.http.middlewares.traefik-authentication.basicauth.usersFile=.htpasswd"
      - "traefik.http.middlewares.traefik-authentication.basicauth.realm=traefik"
      #- "traefik.http.middlewares.traefik-authentication.digestauth.usersFile=.htdigest"
      #- "traefik.http.middlewares.traefik-authentication.digestauth.realm=traefik"
      #- "traefik.http.services.traefik-service.loadbalancer.sticky=true"
      #- "traefik.http.services.traefik-service.loadbalancer.sticky.cookie.httponly=true"
      #- "traefik.http.services.traefik-service.loadbalancer.sticky.cookie.secure=true"
      #- "traefik.http.services.traefik-service.loadbalancer.server.port=8000"

      #####################################################
      # Standard middlewares, available to all containers #
      #####################################################
      - "traefik.http.middlewares.redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect.redirectscheme.permanent=true"
      - "traefik.http.middlewares.compress.compress=true"
      - "traefik.http.middlewares.compress.compress.minResponseBodyBytes=1420"
      - "traefik.http.middlewares.compress.compress.excludedContentTypes=video/*,audio/*,video/h266,video/h265,video/h264,video/av1,video/mp4,video/vp9,video/vp8,video/x-matroska,video/x-msvideo,audio/aac,audio/mp4,audio/mp3,audio/ac3,audio/opus,audio/vorbis,audio/ogg,image/heif,image/webp,image/jpeg,image/png,application/gzip,application/zip,application/zstd"
      - "traefik.http.middlewares.std-headers.headers.addvaryheader=true"
      - "traefik.http.middlewares.std-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.std-headers.headers.contentsecuritypolicy=frame-ancestors 'self' example.com *.example.net ; object-src 'none' ; connect-src 'self' * ;"
      - "traefik.http.middlewares.std-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.std-headers.headers.framedeny=true"
      - "traefik.http.middlewares.std-headers.headers.customFrameOptionsValue=sameorigin"
      - "traefik.http.middlewares.std-headers.headers.stspreload=false"
      - "traefik.http.middlewares.std-headers.headers.customrequestheaders.Proxy=" # https://httpoxy.org
      #- "traefik.http.middlewares.std-headers.headers.customresponseheaders.name0=foobar"
      - "traefik.http.middlewares.no-robots.headers.customresponseheaders.X-Robots-Tag=noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex"
      - >-
          traefik.http.middlewares.std-ipwhitelist.ipwhitelist.sourcerange=192.168.0.0/16, 172.16.0.0/12,
          10.0.0.0/8
      - "traefik.http.middlewares.403.ipwhitelist.sourcerange=127.1.2.7"
      - "traefik.http.middlewares.inflightreq.inflightreq.amount=500"
      - "traefik.http.middlewares.inflightreq.inflightreq.sourcecriterion.ipstrategy.excludedips=127.0.0.1/32, 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8"
      - "traefik.http.middlewares.defaultchain-http.chain.middlewares=std-headers,redirect"
      - "traefik.http.middlewares.defaultchain-https.chain.middlewares=std-headers,inflightreq,compress"
      # The file provider is the only available method to configure the certificates (as well as the options and the stores).
      # https://doc.traefik.io/traefik/v2.10/https/tls/
      #- "traefik.tls.options.default.minVersion=VersionTLS12"
      ##- "traefik.tls.options.default.sniStrict=true"
      #- "traefik.tls.stores.default.defaultgeneratedcert.resolver=letsencrypt"
      #- "traefik.tls.stores.default.defaultgeneratedcert.domain.main=www.example.com"
      #- "traefik.tls.stores.default.defaultgeneratedcert.domain.sans=www.example.net, www.example.org"
      #- "traefik.docker.network=default"
      
      # To disallow /admin path, one can not simply use negative lookaround:
      #   "traefik.http.routers.http.rule=Host(`example.com`) && PathPrefix(`/{re:(?!admin|manager).*}/`)"
      # because: (?!re) before text not matching re (NOT SUPPORTED) (https://github.com/google/re2/wiki/Syntax)
      # Workaround (ugly, but it works): use deny-all middleware:
      # # Allow general traffic (low prioriy rule)
      # - "traefik.http.routers.http.rule=Host(`example.com`)"
      # # Forbid admin endpoint on plain http
      # - "traefik.http.routers.my-403.rule=Host(`example.com`) && PathPrefix(`/{re:(?i:admin|install).*}`)"
      # - "traefik.http.routers.my-403.entrypoints=http"
      # - "traefik.http.routers.my-403.priority=65535"
      # - "traefik.http.routers.my-403.middlewares=403"
      # # IP restriction on https admin endpoint
      # - "traefik.http.routers.my-407.rule=Host(`example.com`) && PathPrefix(`/{re:(?i:admin|install).*}`)"
      # - "traefik.http.routers.my-407.entrypoints=https"
      # - "traefik.http.routers.my-407.priority=65535"
      # - "traefik.http.routers.my-407.middlewares=std-ipwhitelist,defaultchain-https"
    expose:
      - "8080"
    ports:
      - "80:80"
      - "443:443"
    environment:
      # https://docs.traefik.io/v2.10/reference/static-configuration/env/
      - TRAEFIK_GLOBAL_CHECKNEWVERSION=false
      - TRAEFIK_GLOBAL_SENDANONYMOUSUSAGE=false
      - TRAEFIK_PROVIDERS_PROVIDERSTHROTTLEDURATION=2s
      - TRAEFIK_PROVIDERS_DOCKER=true
      #- TRAEFIK_PROVIDERS_DOCKER_ALLOWEMPTYSERVICES=false
      - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT=false
      #- TRAEFIK_PROVIDERS_DOCKER_NETWORK=
      - TRAEFIK_API=true
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_API_DISABLEDASHBOARDAD=true
      - TRAEFIK_PING=true
      - TRAEFIK_PING_ENTRYPOINT=http
      - TRAEFIK_ENTRYPOINTS_traefik=true
      - TRAEFIK_ENTRYPOINTS_traefik_ADDRESS=:8080
      - TRAEFIK_ENTRYPOINTS_http=true
      - TRAEFIK_ENTRYPOINTS_http_ADDRESS=:80
      - TRAEFIK_ENTRYPOINTS_https=true
      - TRAEFIK_ENTRYPOINTS_https_ADDRESS=:443
      - TRAEFIK_ENTRYPOINTS_https_HTTP_TLS=true
      - TRAEFIK_ENTRYPOINTS_https_HTTP_TLS_CERTRESOLVER=letsencrypt
      # see "traefik.tls.options.default.xxx" in Docker labels
      #- TRAEFIK_ENTRYPOINTS_https_HTTP_TLS_OPTIONS=default
      - TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt=true
      #- TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_EMAIL=me@example.com
      #- TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_TLSCHALLENGE=true
      - TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_HTTPCHALLENGE=true
      - TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_HTTPCHALLENGE_ENTRYPOINT=http
      - TRAEFIK_CERTIFICATESRESOLVERS_letsencrypt_ACME_STORAGE=/acme.json
      - TRAEFIK_LOG=true
      # PANIC, FATAL, ERROR, WARN, INFO, DEBUG
      - TRAEFIK_LOG_LEVEL=WARN
      #- TRAEFIK_ACCESSLOG=true
      #- TRAEFIK_ACCESSLOG_BUFFERINGSIZE=100
      #- TRAEFIK_ACCESSLOG_FILTERS_MINDURATION=500ms
      #- TRAEFIK_ACCESSLOG_FILTERS_STATUSCODES="200, 300-302"
      - TRAEFIK_SERVERSTRANSPORT_INSECURESKIPVERIFY=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      #- /opt/traefik/traefik.toml:/etc/traefik/traefik.toml:ro
      # create with: touch /opt/traefik/acme.json && chmod 600 /opt/traefik/acme.json
      - /opt/traefik/acme.json:/acme.json
      #- /opt/traefik/plugins-local:/plugins-local:ro
      # docker container run --rm -ti httpd:2.4-alpine htpasswd -n <user> >> /opt/traefik/htpasswd
      # docker container run --rm -ti -v /opt/traefik/htpasswd:/.htpasswd httpd:2.4-alpine htpasswd /.htpasswd <user>
      - /opt/traefik/htpasswd:/.htpasswd:ro
      # docker container run --rm -ti -v /opt/traefik/htdigest:/.htdigest httpd:2.4-alpine htdigest /.htdigest <realm> <username>
      - /opt/traefik/htdigest:/.htdigest:ro
    healthcheck:
      test: ["CMD", "/usr/local/bin/traefik", "healthcheck"]
      interval: 60s
      timeout: 5s
      retries: 1
      start_period: 20s
    networks:
      # "default" needed to get connectivity from outside(!)
      - default
      - http-static
      - tomcat-front
      - nextcloud-front
      - kavita-front
      - ttrss-front
      - wordpress-front
      - tiddlywiki-front
      - transmission
#      - vaultwarden
#      - icecast-front
#      - daapd-front
      - vpn
      - webssh
      - rclone-front
    cpu_shares: 256
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 64m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

  http-static:
    <<: *base-service
    build: apache-static
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.http-static-http.rule=Host(`example.com`,`example.net`)"
      - "traefik.http.routers.http-static-http.entrypoints=http"
      - "traefik.http.routers.http-static-http.middlewares=defaultchain-http"
      - "traefik.http.routers.http-static-https.rule=Host(`example.com`,`example.net`)"
      - "traefik.http.routers.http-static-https.entrypoints=https"
      - "traefik.http.routers.http-static-https.middlewares=defaultchain-https"
      - "traefik.http.services.http-static-service.loadbalancer.server.port=80"
    expose:
      - "80"
    volumes:
      #- /opt/http-static/mods-available:/opt/http-static/mods-available:ro
      - /opt/http-static/mods-enabled:/opt/http-static/mods-enabled:ro
      #- /opt/http-static/conf-available:/opt/http-static/conf-available:ro
      - /opt/http-static/conf-enabled:/opt/http-static/conf-enabled:ro
      - /opt/http-static/conf-include:/opt/http-static/conf-include:ro
      #- /opt/http-static/sites-available:/opt/http-static/sites-available:ro
      - /opt/http-static/sites-enabled:/opt/http-static/sites-enabled:ro
      - /srv/http-static:/var/www:ro
      - /srv/logs/http-static:/var/log
    networks:
      - http-static
    cpu_shares: 256
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 96m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

  http-proxy:
    <<: *base-service
    build: apache-proxy
#    expose:
#      - "443"
    ports:
      - "80:80"
      - "443:443"
    #depends_on:
      #- tomcat
      #- wordpress
      #- tiddlywiki
      #- transmission
      #- portainer
    volumes:
      #- /opt/http-proxy/mods-available:/opt/http-proxy/mods-available:ro
      - /opt/http-proxy/mods-enabled:/opt/http-proxy/mods-enabled:ro
      #- /opt/http-proxy/conf-available:/opt/http-proxy/conf-available:ro
      - /opt/http-proxy/conf-enabled:/opt/http-proxy/conf-enabled:ro
      - /opt/http-proxy/conf-include:/opt/http-proxy/conf-include:ro
      #- /opt/http-proxy/sites-available:/opt/http-proxy/sites-available:ro
      - /opt/http-proxy/sites-enabled:/opt/http-proxy/sites-enabled:ro
      - /opt/letsencrypt:/etc/letsencrypt:ro,z
      - /srv/GeoIP:/usr/local/share/GeoIP:ro,z
      - /opt/http-proxy/tls:/srv/md
      - /srv/http-proxy:/var/www:ro
      - /srv/logs/http-proxy:/var/log
    networks:
      # "default" needed to get connectivity from outside(!)
      - default
      - tomcat-front
      - nextcloud-front
      - kavita-front
      - ttrss-front
      - wordpress-front
      - tiddlywiki-front
      - transmission
      #- vaultwarden
      #- icecast-front
      - vpn
      - webssh
    cpu_shares: 256
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 64m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

  sslh:
    <<: *base-service
    build: sslh
    #command: ["--ssl", "http-proxy:443", "--openvpn", "openvpn:1194", "--on-timeout", "http-proxy:443"]
    command: ["--tls", "http-proxy:443", "--on-timeout", "http-proxy:443"]
    ports:
      - "9443:443"
    depends_on:
      http-proxy:
        condition: service_started
#      openvpn:
#        condition: service_started
    cap_add:
      - NET_BIND_SERVICE
      - NET_ADMIN
      - SETGID
      - SETUID
    networks:
      - default
#      - vpn
    cpu_shares: 128
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 32m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  portainer:
    <<: *base-service
    image: portainer/portainer-ce
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer-http.rule=Host(`portainer.docker.localhost`)"
      - "traefik.http.routers.portainer-http.entrypoints=http"
      - "traefik.http.routers.portainer-http.middlewares=403"
      - "traefik.http.routers.portainer-https.rule=Host(`portainer.docker.localhost`)"
      - "traefik.http.routers.portainer-https.entrypoints=https"
      - "traefik.http.routers.portainer-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.portainer-service.loadbalancer.server.port=9000"
    #command: ["--tlsverify", "--tlscacert", "/certs/ca.pem", "--tlscert", "/certs/cert.pem", "--tlskey", "/certs/key.pem"]
    #command: ["--templates", "https://raw.githubusercontent.com/portainer/templates/master/templates-2.0.json"]
    expose:
      - "8000"
      - "9000"
      - "9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      #- /opt/portainer/certs:/certs
      - /srv/portainer/data:/data
    cpu_shares: 128
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 32m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  tomcat:
    <<: *base-service
    build:
      context: tomcat
      args:
        - DOCKER_FROM_VERSION=${TOMCAT_VERSION:-9-jdk11}
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=tomcat-front"
      - "traefik.http.routers.tomcat-http.rule=Host(`example.com`,`example.net`)"
      - "traefik.http.routers.tomcat-http.entrypoints=http"
      - "traefik.http.routers.tomcat-http.middlewares=403"
      - "traefik.http.routers.tomcat-https.rule=Host(`example.com`,`example.net`)"
      - "traefik.http.routers.tomcat-https.entrypoints=https"
      - "traefik.http.routers.tomcat-https.middlewares=defaultchain-https"
      - "traefik.http.services.tomcat-service.loadbalancer.server.port=8080"
    expose:
      - "8080"
      - "8443"
      - "8008"
      - "8009"
    environment:
      # See $CATALINA_HOME/bin/catalina.sh for available env vars,
      # and $CATALINA_BASE/bin/setenv.sh for additional configuration
      - CATALINA_BASE=/opt/tomcat/my-instance
    user: tomcat
    volumes:
      - /opt/tomcat:/opt/tomcat
    networks:
      - tomcat-front
      - tomcat-back-internal
      - tomcat-back
    mem_swappiness: 1
    memswap_limit: 1024m
    deploy:
      resources:
        limits:
          memory: 1024m
        reservations:
          memory: 1024m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  base-nextcloud:
    <<: *base-php-service
    #image: nextcloud:latest
    build:
      context: nextcloud
      args:
        - DOCKER_FROM_TAG=${NEXTCLOUD_VERSION:-27-apache}
        - NEWRELIC_LICENSE_KEY=${NEWRELIC_LICENSE_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=nextcloud-front"
      - "traefik.http.routers.nextcloud-http.rule=Host(`nextcloud.example.net`)"
      - "traefik.http.routers.nextcloud-http.entrypoints=http"
      - "traefik.http.routers.nextcloud-http.middlewares=defaultchain-http"
      - "traefik.http.routers.nextcloud-https.rule=Host(`nextcloud.example.net`)"
      - "traefik.http.routers.nextcloud-https.entrypoints=https"
      - "traefik.http.routers.nextcloud-https.priority=1"
      - "traefik.http.routers.nextcloud-https.middlewares=std-ipwhitelist,nextcloud-dav-redirect,defaultchain-https"
      - "traefik.http.services.nextcloud-service.loadbalancer.server.port=80"
      # redirect DAV well-known endpoints
      - "traefik.http.middlewares.nextcloud-dav-redirect.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-dav-redirect.redirectregex.regex=https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-dav-redirect.redirectregex.replacement=https://$$1/remote.php/dav/"
      # https://github.com/nextcloud/notify_push
      - "traefik.http.routers.nextcloud-push-service.rule=Host(`nextcloud.example.net`) && PathPrefix(`/push`)"
      - "traefik.http.routers.nextcloud-push-service.entryPoints=https"
      - "traefik.http.routers.nextcloud-push-service.priority=2"
      - "traefik.http.routers.nextcloud-push-service.middlewares=std-ipwhitelist,nextcloud_strip_push,defaultchain-https"
      - "traefik.http.services.nextcloud-push-service.loadbalancer.server.port=7867"
      # necessary for the notify_push app to work:
      - "traefik.http.middlewares.nextcloud_strip_push.stripprefix.prefixes=/push"    # https://github.com/nextcloud/docker/blob/master/README.md
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=nextcloud
      #- MYSQL_USER=nextcloud
      #- MYSQL_PASSWORD=HJ79WetJELxrbgc3rwed9Jzh
      - REDIS_HOST=redis-nextcloud
      #- REDIS_HOST_PORT=6379
      - REDIS_HOST_PASSWORD=redis
      - SMTP_HOST=email-relay
      - MAIL_FROM_ADDRESS=nextcloud-noreply
      - MAIL_DOMAIN=example.com
      #- NEXTCLOUD_ADMIN_USER=admin
      #- NEXTCLOUD_ADMIN_PASSWORD=x4uhbXqGsG9qU43mPBrvAYE8
      - NEXTCLOUD_DATA_DIR=/srv/nextcloud/data
      #- NEXTCLOUD_TRUSTED_DOMAINS="example.com www.example.com"
      - OVERWRITEHOST=example.net
      - OVERWRITEPROTOCOL=https
      - TRUSTED_PROXIES=127.0.0.1 192.168.0.0/16 172.16.0.0/12 10.0.0.0/8
      # Launch a cron daemon in the background (instead of relying on an external cron)
      #- ENABLE_CRON=1
    expose:
      - "80"
      # High performance backend for Nextcloud Files
      - "7867"
      # High performance backend for Nextcloud Talk
      - "3478/tcp"
      - "3478/udp"
    #depends_on:
    #  mysql:
    #    condition: service_healthy
    #  memcached-nextcloud:
    #    condition: service_healthy
    #  redis-nextcloud:
    #    condition: service_healthy
    #  imaginary:
    #    condition: service_started
    #  newrelic-php-daemon:
    #    condition: service_healthy
    volumes:
      - /opt/nextcloud/config:/var/www/html/config
      - /opt/nextcloud/custom_apps:/var/www/html/custom_apps
      - /opt/nextcloud/themes:/var/www/html/themes
      - /srv/nextcloud/data:/srv/nextcloud/data
    #networks:
    #  - nextcloud-front
    #  - nextcloud-back-internal
    #  - nextcloud-back
    memswap_limit: 768m
    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

  nextcloud:
    extends:
      service: base-nextcloud
    depends_on:
      mysql:
        condition: service_healthy
      memcached-nextcloud:
        condition: service_healthy
      redis-nextcloud:
        condition: service_healthy
      imaginary:
        condition: service_started
      newrelic-php-daemon:
        condition: service_healthy
    volumes:
      - /opt/nextcloud/config:/var/www/html/config
      - /opt/nextcloud/custom_apps:/var/www/html/custom_apps
      - /opt/nextcloud/themes:/var/www/html/themes
      - /srv/nextcloud/data:/srv/nextcloud/data
    networks:
      - nextcloud-front
      - nextcloud-back-internal
      - nextcloud-back

  imaginary:
    #image: h2non/imaginary
    image: docker.io/nextcloud/aio-imaginary
    init: true
    labels:
      - "traefik.enable=false"
    environment:
      - MALLOC_ARENA_MAX=2
      - GOLANG_LOG=warn
    command: -concurrency 10 -cpus 2 -enable-url-source
    expose:
      #- "8088"
      - "9000"
    cap_add:
      - SYS_NICE
    networks:
      - nextcloud-back-internal
   # healthcheck:
   #   #test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9000/"]
   #   test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9000/health"]
   #   interval: 30s
   #   timeout: 5s
   #   retries: 1
   #   start_period: 10s
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 96m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  nextcloud-cron:
    image: nextcloud:${NEXTCLOUD_VERSION:-27-apache}
    init: true
    depends_on:
      mysql:
        condition: service_healthy
      nextcloud:
        condition: service_healthy
    volumes_from:
      - nextcloud
    command: [ "/cron.sh" ]
    networks:
      - nextcloud-back-internal
      - nextcloud-back
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 384m
        reservations:
          memory: 256m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

########################################################################

  wordpress:
    <<: *base-php-service
    #image: wordpress:latest
    build:
      context: wordpress
      args:
        - DOCKER_FROM_TAG=${WORDPRESS_VERSION:-6.2.3-apache}
        - NEWRELIC_LICENSE_KEY=${NEWRELIC_LICENSE_KEY}
        - NEWRELIC_APPLICATION_NAME=WordPress
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=wordpress-front"
      - "traefik.http.routers.wordpress-http.rule=Host(`wordpress.example.net`)"
      - "traefik.http.routers.wordpress-http.entrypoints=http"
      - "traefik.http.routers.wordpress-http.middlewares=defaultchain-http"
      - "traefik.http.routers.wordpress-https.rule=Host(`wordpress.example.net`)"
      - "traefik.http.routers.wordpress-https.entrypoints=https"
      - "traefik.http.routers.wordpress-https.middlewares=defaultchain-https"
      - "traefik.http.services.wordpress-service.loadbalancer.server.port=80"
      # IP restriction on https /admin endpoint
      # Forbid admin endpoint on plain http
      - "traefik.http.routers.wordpress-403.rule=Host(`wordpress.example.net`) && PathPrefix(`/{re:(?i:wp-admin|wp-login|xmlrpc|wp-json).*}`)"
      - "traefik.http.routers.wordpress-403.entrypoints=http"
      - "traefik.http.routers.wordpress-403.priority=65535"
      - "traefik.http.routers.wordpress-403.middlewares=403"
      # IP restriction on https admin endpoint
      - "traefik.http.routers.wordpress-407.rule=Host(`wordpress.example.net`) && PathPrefix(`/{re:(?i:wp-admin|wp-login|xmlrpc|wp-json).*}`)"
      - "traefik.http.routers.wordpress-407.entrypoints=https"
      - "traefik.http.routers.wordpress-407.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.routers.wordpress-407.priority=65535"
    # Only define WORDPRESS_* env var on first startup, until base image switches to docker-entrypoint-ng.sh (i.e. stops `sed`ing wp-config.php and uses env var in wp-config.php instead)
    #environment:
      #WORDPRESS_DB_HOST: mysql
      #WORDPRESS_DB_USER: 
      #WORDPRESS_DB_PASSWORD: 
      #WORDPRESS_DB_NAME: 
      #WORDPRESS_DB_CHARSET: utf8mb4
      #WORDPRESS_DB_COLLATE: utf8_general_ci
      #WORDPRESS_TABLE_PREFIX: wp_
      # WordPress key generator: https://api.wordpress.org/secret-key/1.1/salt/
      #WORDPRESS_AUTH_KEY: 
      #WORDPRESS_SECURE_AUTH_KEY: 
      #WORDPRESS_LOGGED_IN_KEY: 
      #WORDPRESS_NONCE_KEY: 
      #WORDPRESS_AUTH_SALT: 
      #WORDPRESS_SECURE_AUTH_SALT: 
      #WORDPRESS_LOGGED_IN_SALT: 
      #WORDPRESS_NONCE_SALT: 
      #WORDPRESS_CONFIG_EXTRA: | # beware docker-compose requires '$$' for '$'!
      #  /*
      #  @ini_set( 'error_reporting', 4339 );
      #  @ini_set( 'display_errors',  'Off' );
      #  @ini_set( 'display_startup_errors', 'Off' );
      #  @ini_set( 'log_errors', 'On' );
      #  @ini_set( 'error_log', '/home/example.com/logs/php_error.log' );
      #  @ini_set( 'log_errors_max_len', 1024 );
      #  @ini_set( 'ignore_repeated_errors', 'On );
      #  @ini_set( 'ignore_repeated_source', 'Off' );
      #  @ini_set( 'html_errors', 'Off' );
      #  */
      #  @ini_set( 'log_errors', 'Off' );
      #  @ini_set( 'display_errors', 'Off' );
      #  
      #  //define( 'WP_DISABLE_FATAL_ERROR_HANDLER', true );   // 5.2 and later define( 'WP_DEBUG', true );
      #  //define( 'WP_DEBUG_DISPLAY', true ); 
      #  
      #  /*
      #  // If we're behind a proxy server and using HTTPS, we need to alert Wordpress of that fact
      #  // see also https://wordpress.org/support/article/administration-over-ssl/#using-a-reverse-proxy
      #  if (isset($$_SERVER['HTTP_X_FORWARDED_PROTO']) && $$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
      #  	$$_SERVER['HTTPS'] = 'on';
      #  }
      #  */
      #  
      #  //define( 'AUTOSAVE_INTERVAL', 60 ); // Seconds
      #  //define( 'WP_POST_REVISIONS', true );
      #  define( 'WP_POST_REVISIONS', 5 );
      #  //define( 'WP_ALLOW_MULTISITE', false );
      #  
      #  // disable the plugin or theme editor
      #  define( 'DISALLOW_FILE_EDIT', true );
      #  
      #  //define( 'IMAGE_EDIT_OVERWRITE', true );
      #  
      #  // https://wordpress.org/support/article/administration-over-ssl/#to-force-ssl-logins-and-ssl-admin-access
      #  define('FORCE_SSL_ADMIN', true);
      #  
      #  // FIXME enable this, and see what wp-content/advanced-cache.php has to say!
      #  //define( 'WP_CACHE', true ); //Added by WP-Cache Manager
      #  //define( 'WPCACHEHOME', '/var/www/html/wp-content/plugins/wp-super-cache/' ); //Added by WP-Cache Manager
      #  
      #  // Disable the cron entirely (when using external cron URL)
      #  //define( 'DISABLE_WP_CRON', true );
      #  // Make sure a cron process cannot run more than once every WP_CRON_LOCK_TIMEOUT seconds.
      #  define( 'WP_CRON_LOCK_TIMEOUT', 60 );
      #  
      #  //define( 'EMPTY_TRASH_DAYS', 30 ); // 30 days
      #  
      #  // In case of corrupted DB, enable this and then go to $${your_site}/wp-admin/maint/repair.php
      #  //define( 'WP_ALLOW_REPAIR', true );
    depends_on:
      mysql:
        condition: service_healthy
      #memcached-wordpress:
      #  condition: service_healthy
      newrelic-php-daemon:
        condition: service_healthy
    volumes:
      - /srv/wordpress/htaccess:/var/www/html/.htaccess
      - /srv/wordpress/wp-config.php:/var/www/html/wp-config.php
      - /srv/wordpress/wp-content:/var/www/html/wp-content
      - /srv/logs/wordpress:/var/log
    networks:
      - wordpress-front
      - wordpress-back-internal
      - wordpress-back
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 448m
        reservations:
          memory: 256m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

########################################################################

  tiddlywiki:
    <<: *base-service
    build:
      context: tiddlywiki
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tiddlywiki-http.rule=Host(`tiddlywiki.example.net`)"
      - "traefik.http.routers.tiddlywiki-http.entrypoints=http"
      - "traefik.http.routers.tiddlywiki-http.middlewares=defaultchain-http"
      - "traefik.http.routers.tiddlywiki-https.rule=Host(`tiddlywiki.example.net`)"
      - "traefik.http.routers.tiddlywiki-https.entrypoints=https"
      - "traefik.http.routers.tiddlywiki-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.tiddlywiki-service.loadbalancer.server.port=8080"
    expose:
      - "8080"
    environment:
      # See docker-entrypoint.sh for the full list
      - WIKI_FOLDER=wiki
      - PATHPREFIX=
      - PORT=8080
      - ANON_USERNAME=
      - USERNAME=
      - PASSWORD=
    volumes:
      - /srv/tiddlywiki:/srv
    networks:
      - tiddlywiki-front
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 384m
        reservations:
          memory: 256m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  mysql:
    <<: *base-service
    #image: mysql/mysql-server:${MYSQL_VERSION:-8.0}
    image: mysql:${MYSQL_VERSION:-8.0}
    init: true
    labels:
      - "com.symfony.server.service-prefix=DATABASE"
      # The "mysql-cron-backup" label will enable backup via external cron container
      - "mysql-cron-backup"
    # https://dev.mysql.com/doc/mysql-port-reference/en/mysql-ports-reference-tables.html
    expose:
      - "3306"
      - "33060"
      - "33061"
      - "33062"
    environment:
      - MYSQL_ROOT_PASSWORD=
      # http://bugs.mysql.com/bug.php?id=68287 [MySQL 5.6]
      # There are thresholds based on table_open_cache and table_definition_cache and max_connections and crossing the thresholds produces a big increase in RAM used. The thresholds work by first deciding if the server size is small, medium or large.
      # Small: all three are same as or less than defaults (2000, 400, 151). (max 52.6 megabytes RAM)
      # Large: any of the three is more than twice the default. (min 400 megabytes RAM)
      # Medium: others. (90.7-98.4 megabytes RAM)
      # instead of turning off performance_schema, you can reduce RAM usage with --table_open_cache=2000 --table_definition_cache=400 --max_connections=151
      # default values: [MySQL 5.7]
      #   table_open_cache = 2000
      #   table_definition_cache = min(2000, 400 + (table_open_cache / 2))
      #   max_connections = 151
      # https://github.com/mysql/mysql-server/blob/8.0/storage/perfschema/pfs_autosize.cc#estimate_hints
      # https://github.com/mysql/mysql-server/blob/8.0/sql/sys_vars.h
      # https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html
      # default values: [MySQL 8.0]
      #   table_open_cache = 4000
      #   table_definition_cache = min(2000, 400 + (table_open_cache / 2))
      #   max_connections = 151
      # MySQL 8.0 defaults to utf8mb4: https://dev.mysql.com/blog-archive/new-defaults-in-mysql-8-0/
      # To see the effective # open tables:  docker container exec -ti -e MYSQL_PWD=... docker-mysql-1 mysqladmin status
    command: ["--datadir=/var/lib/mysql", "--user=mysql", "--bind-address=0.0.0.0", "--log-error=/var/log/mysql/error.log", "--pid-file=/var/run/mysqld/mysqld.pid", "--socket=/var/run/mysqld/mysqld.sock", "--port=3306", "--performance_schema=off", "--table_open_cache=2000", "--table_definition_cache=800", "--max_connections=101", "--disable-log-bin"]
    tmpfs:
      - /tmp:rw,nosuid,nodev,noexec,size=131072k,mode=1777,strictatime
      - /run/mysqld:rw,nosuid,dev,noexec,relatime,size=16k,uid=999,gid=999,mode=750
    volumes:
      - /opt/mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
      # following 2 files are a hack to enable read_only: true
      - /opt/mysql/healthcheck.cnf:/healthcheck.cnf
      - /opt/mysql/mysql-init-complete:/mysql-init-complete
      #- /opt/mysql/conf.d:/etc/mysql/conf.d
      - /srv/mysql/data:/var/lib/mysql
      - /srv/logs/mysql:/var/log
#    healthcheck:
#      test: ["CMD", "mysqladmin", "--silent", "--no-beep", "--wait=0", "--connect_timeout=1", "--host=127.0.0.1", "--user=${self:services.mysql.environment.MYSQL_USER:-root}", "--password=${self:services.mysql.environment.MYSQL_PASSWORD:-$self:services.mysql.environment.MYSQL_ROOT_PASSWORD}", "ping"]
#      test: mysqladmin --silent --no-beep --wait=0 --connect_timeout=1 --host=127.0.0.1 --user="$${MYSQL_USER:-root}", --password="$${MYSQL_PASSWORD:-$$MYSQL_ROOT_PASSWORD}" ping
#      test: ["CMD", "/docker-entrypoint-initdb.d/docker-healthcheck"]
#      interval: 30s
#      timeout: 5s
#      retries: 1
#      start_period: 10s
    cap_add:
      - SYS_NICE # Fix "mbind: Operation not permitted"
    networks:
      #- tomcat-back-internal
      - nextcloud-back-internal
      - ttrss-back-internal
      - wordpress-back-internal
    #ulimits:
    #  nproc: 65535
    #  nofile:
    #    soft: 20000
    #    hard: 40000
    #cpu_shares: 512
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 448m
        reservations:
          memory: 416m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

  mysql-backup:
    build:
      context: mysql-cron
    init: true
    environment:
      - MYSQL_CRON_LABEL=mysql-cron-backup
      - MYSQL_ROOT_PASSWORD=
    #depends_on:
    #  mysql:
    #    condition: service_started
    volumes:
      - /srv/mysql/backup:/srv
      - /var/run/docker.sock:/var/run/docker.sock:ro
    cpu_shares: 256
    mem_swappiness: 10
    memswap_limit: 128m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 8m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    # logrotate needs /var/lib/logrotate.status and /var/log/messages
    read_only: false

########################################################################

  memcached:
    image: memcached:${MEMCACHED_VERSION:-1.6-alpine}
    init: true
    labels:
      - "com.symfony.server.service-prefix=MEMCACHED"
    command: ["memcached", "--memory-limit=64", "--port=11211", "--udp-port=11211", "--conn-limit=256", "--threads=2"]
    expose:
      - "11211/tcp"
      - "11211/udp"
    healthcheck:
      test: if [ -z "$$(pgrep -x memcached)" ]; then echo "No memcached process!"; exit 1; else exit 0; fi
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 2s
    cpu_shares: 128
    mem_swappiness: 1
    memswap_limit: 128m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 72m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  memcached-wordpress:
    extends:
      service: memcached
    command: ["memcached", "-m", "64", "-p", "11211", "-c", "256", "-t", "1"]
    networks:
      - wordpress-back-internal

  memcached-nextcloud:
    extends:
      service: memcached
    command: ["memcached", "-m", "64", "-p", "11211", "-c", "256", "-t", "1"]
    networks:
      - nextcloud-back-internal

########################################################################

  redis:
    image: redis:${REDIS_VERSION:-6-alpine}
    init: true
    labels:
      - "com.symfony.server.service-prefix=REDIS"
    # https://raw.githubusercontent.com/redis/redis/6.2/redis.conf
    command: ["--daemonize", "no", "--protected-mode", "no", "--tcp-backlog", "511", "--loglevel", "notice", "--logfile", "", "--databases", "1", "--save", "900", "1", "--save", "300", "10", "--save", "60", "10000", "--stop-writes-on-bgsave-error", "yes", "--dbfilename", "dump.rdb", "--dir", "/data", "--maxclients", "100", "--maxmemory", "64mb", "--maxmemory-policy", "noeviction", "--slowlog-log-slower-than", "10000", "--slowlog-max-len", "128", "--requirepass", "redis"]
    expose:
      - "6379"
    environment:
      - REDISCLI_AUTH=redis
    #volumes:
    #- /srv/redis:/data
    healthcheck:
      test: ping="$$(redis-cli --raw ping)" && [ "$$ping" = 'PONG' ] || exit 1
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 2s
    #sysctls:
      #- sys.net.core.somaxconn=511
      #- sys.net.core.tcp_max_syn_backlog=511
      #- vm.overcommit_memory=1
      #- sys.kernel.mm.transparent_hugepage.enabled=never
    cpu_shares: 128
    memswap_limit: 128m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 72m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  redis-nextcloud:
    extends:
      service: redis
    volumes:
      - /srv/redis-nextcloud:/data
    networks:
      - nextcloud-back-internal

########################################################################

  dovecot:
    <<: *base-service
    build: dovecot-imap
    ports:
    # IMAP(s)
    #- "143:143"
    - "993:993"
    # POP3(s)
    #- "110:110"
    #- "995:995"
    # SMTP / submission / SMTPs
    #- "25:25"
    #- "587:587"
    #- "465:465"
    # Sieve
    #- "4190:4190"
    volumes:
      - /opt/dovecot:/opt/dovecot:ro
      - /srv/dovecot:/srv/dovecot
      - /srv/logs/dovecot:/var/log
    tmpfs:
      # this will have the side-effect of regenerating SSL parameters @ each startup
      - /var/lib/dovecot:rw,nosuid,nodev,noexec,size=32k
    networks:
      - dovecot
    cpu_shares: 256
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 96m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  # https://github.com/dani-garcia/vaultwarden/wiki
  vaultwarden:
    <<: *base-service
    #image: vaultwarden/server:latest
    image: vaultwarden/server:alpine
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden-http.rule=Host(`vault.example.net`)"
      - "traefik.http.routers.vaultwarden-http.entrypoints=http"
      - "traefik.http.routers.vaultwarden-http.middlewares=403"
      - "traefik.http.routers.vaultwarden-http.service=vaultwarden-web"
      - "traefik.http.routers.vaultwarden-https.rule=Host(`vault.example.net`)"
      - "traefik.http.routers.vaultwarden-https.entrypoints=https"
      - "traefik.http.routers.vaultwarden-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.routers.vaultwarden-https.service=vaultwarden-web"
      - "traefik.http.services.vaultwarden-web.loadbalancer.server.port=80"
      
      - "traefik.http.routers.vaultwarden-hub.rule=Host(`vault.example.net`) && PathPrefix(`/notifications/hub`)"
      - "traefik.http.routers.vaultwarden-hub.entrypoints=https"
      - "traefik.http.routers.vaultwarden-hub.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.routers.vaultwarden-hub.service=vaultwarden-hub"
      - "traefik.http.services.vaultwarden-hub.loadbalancer.server.port=3012"
      
      - "traefik.http.routers.vaultwarden-negociate.rule=Host(`vault.example.net`) && PathPrefix(`/notifications/hub/negotiate`)"
      - "traefik.http.routers.vaultwarden-negociate.entrypoints=https"
      - "traefik.http.routers.vaultwarden-negociate.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.routers.vaultwarden-negociate.service=vaultwarden-negociate"
      - "traefik.http.services.vaultwarden-negociate.loadbalancer.server.port=80"
      
      # IP restriction on https /admin endpoint
      # Forbid admin endpoint on plain http
      - "traefik.http.routers.vaultwarden-403.rule=Host(`vault.example.net`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.vaultwarden-403.entrypoints=http"
      - "traefik.http.routers.vaultwarden-403.priority=65535"
      - "traefik.http.routers.vaultwarden-403.middlewares=403"
      - "traefik.http.routers.vaultwarden-403.service=vaultwarden-web"
      # IP restriction on https admin endpoint
      - "traefik.http.routers.vaultwarden-407.rule=Host(`vault.example.net`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.vaultwarden-407.entrypoints=https"
      - "traefik.http.routers.vaultwarden-407.priority=65535"
      - "traefik.http.routers.vaultwarden-407.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.routers.vaultwarden-407.service=vaultwarden-web"
    expose:
      - "80"
      - "3012"
    # See https://github.com/dani-garcia/vaultwarden/blob/master/.env.template
    environment:
      #- DOMAIN=https://vw.example.com
      - SIGNUPS_ALLOWED=false
      #- SIGNUPS_DOMAINS_WHITELIST=example.com,example.net,example.org
      - SIGNUPS_VERIFY=true
      - INVITATIONS_ALLOWED=false
      #- INVITATION_ORG_NAME=Vaultwarden
      #- ORG_CREATION_USERS=none
      - USER_ATTACHMENT_LIMIT=1048576
      - ORG_ATTACHMENT_LIMIT=1073741824
      - TRASH_AUTO_DELETE_DAYS=366
      # generate token: e.g. `openssl rand -base64 48`
      #- ADMIN_TOKEN=Vy2VyYTTsKPv8W5aEOWUbB/Bt3DEKePbHmI4m9VcemUMS2rEviDowNAFqYi1xjmp
      #- LOGIN_RATELIMIT_SECONDS=60
      #- LOGIN_RATELIMIT_MAX_BURST=10
      #- ADMIN_RATELIMIT_SECONDS=300
      #- ADMIN_RATELIMIT_MAX_BURST=3
      #- WEB_VAULT_ENABLED=true
      - WEBSOCKET_ENABLED=true
      - SENDS_ALLOWED=false
      #- SHOW_PASSWORD_HINT=true
      #- DISABLE_ICON_DOWNLOAD=false
      #- ROCKET_PORT=80
      #- ROCKET_LIMITS={json=10485760}
      - ROCKET_ENV=production
      #- IP_HEADER=X-Real-IP
      - SMTP_FROM=vaultwarden@example.com
      - SMTP_FROM_NAME=Vaultwarden
      - SMTP_HOST=email-relay
      - SMTP_PORT=25
      - SMTP_SECURITY=starttls
      #- SMTP_USERNAME=
      #- SMTP_PASSWORD=
      #- HIBP_API_KEY=
      # Logging to file; it is recommended to also set 'ROCKET_CLI_COLORS=off'
      #- LOG_FILE=/data/vaultwarden.log
      - LOG_LEVEL=warn
    volumes:
      - /srv/vaultwarden/data:/data
    networks:
      - vaultwarden
    cpu_shares: 512
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 256m
        reservations:
          memory: 64m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  # https://gitlab.com/1O/vaultwarden-backup
  vaultwarden-db-backup:
    <<: *base-service
    image: bruceforce/vaultwarden-backup:latest
    init: true
    environment:
      #- BACKUP_DIR=/backup
      - BACKUP_ADD_DATABASE=true
      - BACKUP_ADD_ATTACHMENTS=false
      - BACKUP_ADD_CONFIG_JSON=false
      - BACKUP_ADD_ICON_CACHE=false
      - BACKUP_ADD_RSA_KEY=false
      - BACKUP_ADD_SENDS=false
      - DELETE_AFTER=15
      - TIMESTAMP=true
      #- HEALTHCHECK_URL=
      - LOG_LEVEL=WARNING
    volumes:
      - /srv/vaultwarden/data:/data:ro
      - /srv/vaultwarden/backup:/backup
      #- /srv/logs/vaultwarden-backup:/app/log

########################################################################

  web-ssh:
    build: web-ssh
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webssh-http.rule=Host(`webssh.docker.localhost`)"
      - "traefik.http.routers.webssh-http.entrypoints=http"
      - "traefik.http.routers.webssh-http.middlewares=403"
      - "traefik.http.routers.webssh-https.rule=Host(`webssh.docker.localhost`)"
      - "traefik.http.routers.webssh-https.entrypoints=https"
      - "traefik.http.routers.webssh-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.webssh-service.loadbalancer.server.port=8888"
    expose:
      - "8888"
      - "4433"
    environment:
      - NEW_RELIC_LICENSE_KEY=${NEWRELIC_LICENSE_KEY}
      - NEW_RELIC_APP_NAME=WebSSH
      #- NEW_RELIC_HIGH_SECURITY=true
      - NEW_RELIC_LOG=stdout
      - NEW_RELIC_LOG_LEVEL=info
    volumes:
      - /srv/webssh:/srv
    networks:
      - webssh
    cpu_shares: 256
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 24m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  # https://github.com/nirui/sshwifty
  sshwifty:
    image: niruix/sshwifty
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sshwifty-http.rule=Host(`webssh.docker.localhost`)"
      - "traefik.http.routers.sshwifty-http.entrypoints=http"
      - "traefik.http.routers.sshwifty-http.middlewares=403"
      - "traefik.http.routers.sshwifty-https.rule=Host(`webssh.docker.localhost`)"
      - "traefik.http.routers.sshwifty-https.entrypoints=https"
      - "traefik.http.routers.sshwifty-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.sshwifty-service.loadbalancer.server.port=8182"
    expose:
      - "8182"
    environment:
      # HTTP Host. Keep it empty to accept request from all hosts, otherwise, only
      # specified host is allowed to access
      - SSHWIFTY_HOSTNAME=
      # Web interface access password. Set to empty to allow public access
      - SharedKey=WEB_ACCESS_PASSWORD
    #volumes:
    #  - /srv/webssh:/srv
    networks:
      - webssh
    cpu_shares: 256
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 24m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

########################################################################

  # AdGuard Home is our internal + external (ACLs) DNS server
  adguard-home:
    image: adguard/adguardhome:latest
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adguardhome-http.rule=Host(`adguard.docker.localhost`)"
      - "traefik.http.routers.adguardhome-http.entrypoints=http"
      - "traefik.http.routers.adguardhome-http.middlewares=403"
      - "traefik.http.routers.adguardhome-https.rule=Host(`adguard.docker.localhost`)"
      - "traefik.http.routers.adguardhome-https.entrypoints=https"
      - "traefik.http.routers.adguardhome-https.middlewares=std-ipwhitelist,defaultchain-https,no-robots"
      - "traefik.http.services.adguardhome-service.loadbalancer.server.port=3000"
    ports:
      #- "192.0.2.1:53:53/tcp"
      #- "192.0.2.1:53:53/udp"
      - "853:853/tcp"
      - "853:853/udp"
    expose:
      # DNS
      - "53/tcp"
      - "53/udp"
      # DHCP
      - "67/udp"
      - "68/udp"
      - "80"
      # DoH
      - "443"
      # DoT
      - "853/tcp"
      # DoQ
      - "853/udp"
      # web console
      - "3000"
      # DNSCrypt
      - "5443/tcp"
      - "5443/udp"
      # debug_pprof e.g. http://localhost:6060/debug/pprof/profile?seconds=30
      # if you have go and graphwiz installed, you can take a look: go tool pprof -http localhost:3434 path_to_dump will open a nice UI interface for exploring the dump
      - "6060"
    volumes:
      - /opt/adguard-home:/opt/adguardhome/conf
      - /srv/adguard-home:/opt/adguardhome/work
      #- /opt/letsencrypt:/etc/letsencrypt:ro,z
      - /opt/http-proxy/tls:/opt/tls:ro,z
    user: nobody
    working_dir: /opt/adguardhome/work
    cap_add:
      - NET_BIND_SERVICE
    networks:
      vpn:
        ipv4_address: 172.31.53.53
    #sysctls:
      # https://github.com/lucas-clemente/quic-go/wiki/UDP-Receive-Buffer-Size
      #- net.core.rmem_max=2500000
    cpu_shares: 512
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 384m
        reservations:
          memory: 96m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

########################################################################

  web-accelerator:
    <<: *base-service
    build: ziproxy
    expose:
      - "3128"
    dns:
      - 172.31.53.53
    #volumes:
      #- /srv/logs/ziproxy:/var/log
    networks:
      vpn:
        ipv4_address: 172.31.53.28
    cpu_shares: 128
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 8m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  openvpn:
    <<: *base-service
    build:
      context: vpn-openvpn
      args:
        # stable|testing|release/2.3|release/2.4
        - OPENVPN_VERSION=stable
    #devices:
    #  - "/dev/net/tun:/dev/net/tun:rwm"
    ports:
      - "1194:1194/udp"
      - "443:1194/udp"
      #- "1194:1194/tcp"
    environment:
      #- PROTOCOL=udp
      #- DNS_USE_RESOLVCONF=true
      #- DNS_EXTRA_SERVER_1=172.31.53.254
      - DNS_EXTRA_SERVER_1=172.31.53.53
      #- DNS_EXTRA_SERVER_2=8.8.4.4
      # OpenVPN extra options
      #- OPENVPN_OPTS=
      # See https://github.com/OpenVPN/easy-rsa/blob/master/doc/EasyRSA-Advanced.md
      - EASYRSA_REQ_COUNTRY=US
      - EASYRSA_REQ_PROVINCE=California
      - EASYRSA_REQ_CITY=San Francisco
      - EASYRSA_REQ_ORG=Copyleft Certificate Co
      #- EASYRSA_REQ_EMAIL=me@example.net
      #- EASYRSA_REQ_OU=My Organizational Unit
      #- EASYRSA_KEY_SIZE=2048
      # CA expiration time in days
      #- EASYRSA_CA_EXPIRE=3650
      # issued cert expiration time in days
      #- EASYRSA_CERT_EXPIRE=3650
      #- EASYRSA_REQ_CN=ChangeMe
      #- EASYRSA_BATCH=
    depends_on:
      adguard-home:
        condition: service_started
      web-accelerator:
        condition: service_started
    dns:
      - 172.31.53.53
      # use service on gateway IP since docker-compose 1.6 can't assign a fixed IP to dns container
      #- 172.31.53.254
    volumes:
      - /opt/openvpn:/etc/openvpn
      # Required for `modprobe tun`
      - /lib/modules:/lib/modules:ro
      #- /srv/logs/openvpn:/var/log
      #tmpfs:
      # required to have the container read-only in docker < 17.12.0
      #- /dev/net:rw,nosuid,dev,noexec,relatime,size=16k
      #- /var/log
    cap_add:
      - NET_ADMIN
    networks:
      - vpn
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.send_redirects=0
      - net.ipv6.conf.default.forwarding=1
      - net.ipv6.conf.all.forwarding=1
    cpu_shares: 128
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 8m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  transmission:
    <<: *base-service
    build:
      context: transmission
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transmission-http.rule=Host(`example.net`) && PathPrefix(`/transmission/`)"
      - "traefik.http.routers.transmission-http.entrypoints=http"
      - "traefik.http.routers.transmission-http.middlewares=403"
      - "traefik.http.routers.transmission-https.rule=Host(`example.net`) && PathPrefix(`/transmission/`)"
      - "traefik.http.routers.transmission-https.entrypoints=https"
      - "traefik.http.routers.transmission-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.transmission-service.loadbalancer.server.port=9091"
    expose:
      - "9091"
    ports:
      - "51413:51413/tcp"
      - "51413:51413/udp"
    volumes:
      - /srv/transmission:/var/lib/transmission-daemon
      # Required for `modprobe tcp_lp`
      - /lib/modules:/lib/modules:ro
    networks:
      - transmission
    #sysctls:
      #- net.core.rmem_max=4194304
      #- net.core.wmem_max=1048576
    cpu_shares: 64
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 64m
      restart_policy:
        condition: "no"  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    #blkio_config:
    #   weight: 10  # 10..1000

########################################################################

  tt-rss:
    <<: *base-php-service
    build:
      context: tt-rss
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ttrss-front"
      - "traefik.http.routers.ttrss-http.rule=Host(`ttrss.example.net`))"
      - "traefik.http.routers.ttrss-http.entrypoints=http"
      - "traefik.http.routers.ttrss-http.middlewares=403"
      - "traefik.http.routers.ttrss-https.rule=Host(`ttrss.example.net`)"
      - "traefik.http.routers.ttrss-https.entrypoints=https"
      - "traefik.http.routers.ttrss-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.ttrss-service.loadbalancer.server.port=80"
    environment:
      # Don't change this one!
      - ENABLE_CRON=1
      # https://git.tt-rss.org/fox/tt-rss.git/tree/classes/config.php
      - TTRSS_DB_TYPE=mysql
      - TTRSS_DB_HOST=mysql
      - TTRSS_DB_PORT=3306
      - TTRSS_DB_USER=fox
      - TTRSS_DB_NAME=fox
      - TTRSS_DB_PASS=
      - TTRSS_SELF_URL_PATH=https://ttrss.example.net
      - TTRSS_REG_NOTIFY_ADDRESS=user@your.domain.dom
      - TTRSS_SMTP_FROM_ADDRESS=noreply@your.domain.dom
      - TTRSS_PHP_EXECUTABLE=/usr/local/bin/php
      - TTRSS_CHECK_FOR_UPDATES=false
      - TTRSS_PLUGINS=auth_internal, mailer_smtp, data_migration, af_zz_noautoplay
      - TTRSS_LOG_DESTINATION=
      - TTRSS_CHECK_FOR_PLUGIN_UPDATES=false
      - TTRSS_ENABLE_PLUGIN_INSTALLER=false
      # plugin: af_img_phash (optional)
      - TTRSS_IMG_HASH_SQL_FUNCTION=true
      #  plugin: mailer_smtp
      # Hostname:port combination to send outgoing mail (i.e. localhost:25).
      # Blank - use system MTA.
      # Also change 'SMTP_FROM_NAME' and 'SMTP_FROM_ADDRESS' in config.php
      - TTRSS_SMTP_SERVER=email-relay:25
      # These two options enable SMTP authentication when sending
      # outgoing mail. Only used with SMTP_SERVER.
      - TTRSS_SMTP_LOGIN=
      - TTRSS_SMTP_PASSWORD=
      # Used to select a secure SMTP connection. Allowed values: ssl, tls, or empty.
      - TTRSS_SMTP_SECURE=
      # Accept all SSL certificates, use with caution.
      #- TTRSS_SMTP_SKIP_CERT_CHECKS=false
      # Use a custom CA certificate for SSL/TLS secure connections.
      # Only used if SMTP_SKIP_CERT_CHECKS is false.
      #- TTRSS_SMTP_CA_FILE=/path/to/ca.crt
      # plugin: nginx_xaccel
      #- TTRSS_NGINX_XACCEL_PREFIX=/tt-rss
    depends_on:
      mysql:
        condition: service_healthy
      newrelic-php-daemon:
        condition: service_healthy
    #volumes:
      #- /srv/tt-rss:/var/www/html
    networks:
      - ttrss-front
      - ttrss-back-internal
      - ttrss-back
    cpu_shares: 64
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 64m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

########################################################################

  icecast:
    <<: *base-service
    build:
      context: icecast
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=icecast-front"
      - "traefik.http.routers.icecast-http.rule=Host(`icecast.docker.localhost`)"
      - "traefik.http.routers.icecast-http.entrypoints=http"
      - "traefik.http.routers.icecast-http.middlewares=403"
      - "traefik.http.routers.icecast-https.rule=Host(`icecast.docker.localhost`)"
      - "traefik.http.routers.icecast-https.entrypoints=https"
      - "traefik.http.routers.icecast-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.icecast-service.loadbalancer.server.port=8000"
      # /admin is protected by Icecast configuration
    volumes:
      - /opt/icecast/icecast.xml:/etc/icecast.xml:ro
      - /opt/icecast/htpasswd:/etc/icecast.htpasswd
      - /srv/logs/icecast:/var/log/icecast
    healthcheck:
      test: ["CMD", "pgrep", "-x", "icecast"]
      interval: 240s
      timeout: 5s
      retries: 1
      start_period: 10s
    networks:
      - icecast-front
      - icecast-back-internal
    expose:
      - "8000"
      - "8001"
      - "8080"
      - "8443"
    command: ["icecast", "-c", "/etc/icecast.xml"]
    cpu_shares: 128
    memswap_limit: 32m
    deploy:
      resources:
        limits:
          memory: 32m
        reservations:
          memory: 4m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

  darkice:
    <<: *base-service
    build:
      context: darkice
    init: true
    labels:
      - "traefik.enable=false"
    depends_on:
      icecast:
        condition: service_healthy
    group_add:
      - audio
      # /dev/snd is group-owned by `audio` which is not the same gid on host than in container!
      # getent group audio | awk -F: '{print $3}'
      - "29"
    devices:
      - "/dev/snd:/dev/snd"
    volumes:
      - /opt/darkice/darkice.cfg:/etc/darkice.cfg:ro
      # can not mount /proc/asound this way, and can't make security_opt systempaths=unconfined... But doesn't seem to be needed...
      #- "/proc/asound:/proc/asound:ro"
    healthcheck:
      test: ["CMD", "pgrep", "-x", "darkice"]
      interval: 240s
      timeout: 5s
      retries: 1
      start_period: 10s
    networks:
      - icecast-back-internal
    command: ["darkice", "-c", "/etc/darkice.cfg"]
    #security_opt:
    #  - systempaths:unconfined
    cpu_shares: 256
    memswap_limit: 16m
    deploy:
      resources:
        limits:
          memory: 16m
        reservations:
          memory: 4m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    #privileged: false

########################################################################

#  forked-daapd:
#    <<: *base-service
#    image: linuxserver/daapd
#    init: false
#    labels:
#      - "traefik.enable=false"
#    ports:
#      # DAAP
#      - "3689:3689"
#      # websocket
#      - "3688:3688"
#      # MPD
#      - "6600:6600"
#      # mDNS
#      - "5353:5353/udp"
#      # SSDP
#      - "1900:1900/udp"
#    expose:
#      - "3689"
#      - "3688"
#      - "6600"
#      - "5353/udp"
#      - "1900/udp"
#    environment:
#      - PUID=1000
#      - PGID=1000
#      - TZ=Europe/Paris
#    devices:
#      - "/dev/snd:/dev/snd"
#    volumes:
#      - /opt/forked-daapd:/config
#      - /srv/forked-daapd:/music:ro
#      #- /srv/logs/forked-daapd:/var/log
#    healthcheck:
#      test: ["CMD", "pgrep", "forked-daapd"]
#      interval: 240s
#      timeout: 5s
#      retries: 1
#      start_period: 10s
#    networks:
#      - daapd-front
##    network_mode: "host"
#    cpu_shares: 128
#    memswap_limit: 96m
#    deploy:
#      resources:
#        limits:
#          memory: 64m
#        reservations:
#          memory: 24m
#      restart_policy:
#        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
#        delay: 5s  # (default: 0)
#        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
#    read_only: false

########################################################################

#  # https://homebridge.io
#  homebridge:
#    <<: *base-service
#    image: oznu/homebridge:latest
#    init: true
#    labels:
#      - "traefik.enable=true"
#      - "traefik.docker.network=homebridge-front"
#      - "traefik.http.routers.homebridge-http.rule=Host(`homebridge.docker.localhost`)"
#      - "traefik.http.routers.homebridge-http.entrypoints=http"
#      - "traefik.http.routers.homebridge-http.middlewares=403"
#      - "traefik.http.routers.homebridge-https.rule=Host(`homebridge.docker.localhost`)"
#      - "traefik.http.routers.homebridge-https.entrypoints=https"
#      - "traefik.http.routers.homebridge-https.middlewares=std-ipwhitelist,defaultchain-https"
#      - "traefik.http.services.homebridge-service.loadbalancer.server.port=8581"
#    volumes:
#      - /opt/homebridge:/homebridge
#    healthcheck:
#      test: ["CMD", "pgrep", "-x", "homebridge"]
#      interval: 240s
#      timeout: 5s
#      retries: 1
#      start_period: 10s
#    network_mode: host
#    networks:
#      - homebridge-front
#      - homebridge-back-internal
#    expose:
#      - "8581"
#    environment:
#      - TZ=Europe/Paris
#      - PGID=1000
#      - PUID=1000
#      - HOMEBRIDGE_CONFIG_UI=1
#      - HOMEBRIDGE_CONFIG_UI_PORT=8581
#    cpu_shares: 128
#    memswap_limit: 192m
#    deploy:
#      resources:
#        limits:
#          memory: 128m
#        reservations:
#          memory: 32m
#      restart_policy:
#        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
#        delay: 5s  # (default: 0)
#        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  # https://github.com/maxmind/geoipupdate/blob/master/doc/docker.md
  geoipupdate:
    <<: *base-service
    image: ghcr.io/maxmind/geoipupdate
    init: true
    labels:
      - "traefik.enable=false"
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=XXXXXX
      - GEOIPUPDATE_LICENSE_KEY=XXXXXXXXXXXXXXXX
      - 'GEOIPUPDATE_EDITION_IDS=GeoLite2-ASN GeoLite2-City GeoLite2-Country'
      - GEOIPUPDATE_FREQUENCY=720
      - GEOIPUPDATE_PRESERVE_FILE_TIMES=1
      #- GEOIPUPDATE_VERBOSE=1
      - GEOIPUPDATE_CONF_FILE=/usr/share/GeoIP/GeoIP.conf
    volumes:
      - /opt/GeoIP:/var/lib/geoipupdate
      - /srv/GeoIP:/usr/share/GeoIP
    user: nobody
    cpu_shares: 128
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 8m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

########################################################################

  # https://jellyfin.org/docs/general/administration/installing.html#container-images
  # Alternatives:
  #   linuxserver/jellyfin	https://github.com/linuxserver/docker-jellyfin
  #   hotio/jellyfin:release	https://github.com/hotio/jellyfin/
  jellyfin:
    <<: *base-service
    image: jellyfin/jellyfin
    init: true
    labels:
      # See https://jellyfin.org/docs/general/networking/traefik2.html
      - "traefik.enable=false"
      #- "traefik.docker.network=default"
      - "traefik.http.routers.jellyfin-http.rule=Host(`jellyfin.docker.localhost`)"
      - "traefik.http.routers.jellyfin-http.entrypoints=http"
      - "traefik.http.routers.jellyfin-http.middlewares=403"
      - "traefik.http.routers.jellyfin-https.rule=Host(`jellyfin.docker.localhost`)"
      - "traefik.http.routers.jellyfin-https.entrypoints=https"
      - "traefik.http.routers.jellyfin-https.middlewares=std-ipwhitelist,defaultchain-https,no-robots"
      - "traefik.http.services.jellyfin-service.loadbalancer.server.port=8096"
    user: nobody:nogroup
    group_add: # by id as these may not exist within the container. Needed to provide permissions to the VAAPI Devices
      - "107" #render
      - "44"  #video
    expose:
      # HTTP web UI
      - "8096"
      # HTTPS web UI (you need to set up your own certificate)
      - "8920"
      # Allows clients to discover Jellyfin on the local network
      - "7359/udp"
      # Service discovery, used by DNLA and clients; required to be in the local subnet
      - "1900/udp"
    ports:
      - "1900:1900/udp"
      - "7359:7359/udp"
    #devices: #optional
      # https://jellyfin.org/docs/general/administration/hardware-acceleration.html
      # Intel QuickSync GPU for hardware accelerated video encoding (vaapi)
      #- /dev/dri:/dev/dri
      # tuner
      #- /dev/dvb:/dev/dvb
      # Raspberry Pi MMAL video decoding (Enabled as OpenMax H264 decode in gui settings)
      #- /dev/vcsm:/dev/vcsm
      #- /dev/vc-mem:/dev/vc-mem
      # Raspberry Pi OpenMax video encoding
      #- /dev/vchiq:/dev/vchiq
      # Raspberry Pi V4L2 video encoding
      #- /dev/video10:/dev/video10
      #- /dev/video11:/dev/video11
      #- /dev/video12:/dev/video12
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      # https://jellyfin.org/docs/general/administration/configuration.html
      #- JELLYFIN_DATA_DIR=/config
      #- JELLYFIN_CONFIG_DIR=/config/config
      #- JELLYFIN_CACHE_DIR=/cache
      - JELLYFIN_LOG_DIR=/log
      #- JELLYFIN_MEDIA_DIR=/media
      #- JELLYFIN_NOWEBCONTENT=false
      - JELLYFIN_PublishedServerUrl=http://192.0.2.1
    volumes:
      - /opt/jellyfin:/config
      - /srv/jellyfin/cache:/cache
      - /srv/jellyfin/log:/log
      #- /srv/jellyfin/media:/media:ro
      # Raspberry Pi OpenMAX libs
      #- /opt/vc/lib:/opt/vc/lib:ro
    #networks:
    #  - jellyfin-front
    # Network mode of 'host' exposes the ports on the host. This is needed for DLNA access or HDHomeRun.
#    network_mode: "host"
    cpu_shares: 256
    memswap_limit: 384m
    deploy:
      resources:
        limits:
          memory: 256m
        reservations:
          memory: 96m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

########################################################################

  # https://github.com/plexinc/pms-docker
  plex:
    #image: plexinc/pms-docker:latest
    build:
      context: pms-docker
      dockerfile: Dockerfile.armv7
      args:
        # https://hub.docker.com/r/plexinc/pms-docker/tags
        - TAG=1.31.3.6868-28fc46b27
        #- URL=https://downloads.plex.tv/plex-media-server-new/1.31.3.6868-28fc46b27/debian/plexmediaserver_1.31.3.6868-28fc46b27_armhf.deb
    init: false
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=pms-front"
      - "traefik.http.routers.pms-http.rule=Host(`plex.docker.localhost`)"
      - "traefik.http.routers.pms-http.entrypoints=http"
      - "traefik.http.routers.pms-http.middlewares=403"
      - "traefik.http.routers.pms-http.service=pms-web"
      - "traefik.http.routers.pms-https.rule=Host(`plex.docker.localhost`)"
      - "traefik.http.routers.pms-https.entrypoints=https"
      - "traefik.http.routers.pms-https.middlewares=std-ipwhitelist,defaultchain-https,no-robots"
      - "traefik.http.routers.pms-https.service=pms-web"
      - "traefik.http.services.pms-web.loadbalancer.server.port=32400"
    expose:
      # https://support.plex.tv/hc/en-us/articles/201543147-What-network-ports-do-I-need-to-allow-through-my-firewall
      # access to the Plex Media Server (required)
      - "32400"
      # controlling Plex for Roku via Plex Companion
      - "8324"
      # access to the Plex DLNA Server
      - "32469"
      # access to the Plex DLNA Server
      - "1900/udp"
      # current GDM network discovery
      - "32410/udp"
      - "32412/udp"
      - "32413/udp"
      - "32414/udp"
      # older Bonjour/Avahi network discovery
      - "5353/udp"
    #devices:
      # Intel QuickSync GPU for hardware accelerated video encoding (vaapi)
      #- /dev/dri:/dev/dri
      #- /dev/dvb:/dev/dvb
    hostname: PlexServer
    environment:
      - HOSTNAME=PlexServer
      - TZ=Europe/Paris
      #- PLEX_CLAIM=<claimToken>
      - ADVERTISE_IP=https://plex.docker.localhost:443/
      #- PLEX_UID=1000
      #- PLEX_GID=1000
      - CHANGE_CONFIG_DIR_OWNERSHIP=false
      - ALLOWED_NETWORKS=192.168.0.0/255.255.255.0,172.16.0.0/255.240.0.0,10.0.0.0/255.0.0.0
      #- DEBUG=false
    #depends_on:
    #  email-relay:
    #    condition: service_started
#    tmpfs:
#      # default tmpfs opts: rw,nosuid,nodev,noexec,relatime,size=65536k
#      - /run:rw,nosuid,noexec,relatime,size=65536k,mode=755
#      - /run/s6:rw,relatime,size=65536k,mode=755
#      - /run/lock:rw,nosuid,nodev,noexec,relatime,size=5120k,mode=1777
#      #- /var/log
#      #- /var/cache
#      #- /var/tmp
#      - /tmp:rw,nosuid,nodev,noexec,size=131072k,mode=1777,strictatime
#      # required for syslog
#      #- /var/lib/syslog-ng:rw,nosuid,nodev,noexec,relatime,size=16k
#      # required for logrotate
#      - /var/lib/logrotate:rw,nosuid,nodev,noexec,relatime,size=16k
    volumes:
      - /opt/plex:/config
      #- /tmp/plex:/transcode
      #- /srv/plex:/data:ro
    #networks:
    #  - pms-front
      #- pms-back
      #- pms-back-internal
    cpu_shares: 768
    memswap_limit: 512m
    # 1st run: set read_only to false
    read_only: false
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '1.0'  # number of cores
          memory: 384m
        reservations:
          cpus: '0.1'  # number of cores
          memory: 128m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        #max_attempts: 3  # (default: never give up)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)

########################################################################

  kavita:
    <<: *base-service
    image: kizaing/kavita
    init: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.kavita-http.rule=Host(`kavita.example.net`)"
      - "traefik.http.routers.kavita-http.entrypoints=http"
      - "traefik.http.routers.kavita-http.middlewares=defaultchain-http"
      - "traefik.http.routers.kavita-https.rule=Host(`kavita.example.net`)"
      - "traefik.http.routers.kavita-https.entrypoints=https"
      - "traefik.http.routers.kavita-https.middlewares=std-ipwhitelist,defaultchain-https"
      - "traefik.http.services.kavita-service.loadbalancer.server.port=5000"
    expose:
      - "5000"
    environment:
      - TZ=Europe/Paris
    depends_on:
      kavita-email:
        condition: service_started
    volumes:
      - /opt/kavita:/kavita/config
      #- /srv/http-proxy/manga:/srv/manga:ro
      #- /srv/http-proxy/comics:/srv/comics:ro
      #- /srv/http-proxy/light-novels:/srv/light-novels:ro
      - /srv/http-proxy/ebooks:/srv/ebooks:ro
    networks:
      - kavita-front
      - kavita-back
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          memory: 384m
        reservations:
          memory: 256m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

  kavita-email:
    <<: *base-service
    image: kizaing/kavitaemail
    init: true
    labels:
      - "traefik.enable=false"
    expose:
      - "5003"
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
    volumes:
      - /opt/kavita-email:/app/config
    networks:
      kavita-back:
        aliases:
          - stats.kavitareader.com
          - email.kavitareader.com
    memswap_limit: 192m
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 32m
      restart_policy:
        condition: unless-stopped  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: false

########################################################################

  # https://rclone.org/commands/rclone_serve_restic/
  base-rclone-restic-server:
    image: rclone/rclone:${RCLONE_VERSION:-1.63}
    init: true
    labels:
      - "traefik.enable=false"
      #- "traefik.http.routers.rclone-restic-http.rule=Host(`restic.example.net`)"
      #- "traefik.http.routers.rclone-restic-http.entrypoints=http"
      #- "traefik.http.routers.rclone-restic-http.middlewares=403"
      #- "traefik.http.routers.rclone-restic-https.rule=Host(`restic.example.net`)"
      #- "traefik.http.routers.rclone-restic-https.entrypoints=https"
      #- "traefik.http.routers.rclone-restic-https.middlewares=std-ipwhitelist,defaultchain-https"
      #- "traefik.http.services.rclone-restic-service.loadbalancer.server.port=8080"
    expose:
      - "8080"
    environment:
      - RCLONE_ADDR=0.0.0.0:8080
      - RCLONE_HTPASSWD=/config/htpasswd
      - RCLONE_PRIVATE_REPOS=true
      - RCLONE_APPEND_ONLY=true
      - RCLONE_QUIET=true
      - RCLONE_DSCP=BE
      - RCLONE_CUTOFF_MODE=soft
      - RCLONE_FAST_LIST=true
      - RCLONE_METADATA=true
      - RCLONE_LINKS=true
      #- RCLONE_CHECKSUM=true
      #- RCLONE_TRACK_RENAMES=true
      #- RCLONE_TRACK_RENAMES_STRATEGY=size,hash,leaf,modtime
      - RCLONE_ONEDRIVE_NO_VERSIONS=true
      - RCLONE_COMPRESS_LEVEL=1
      - RCLONE_BWLIMIT=40M
    user: rclone
    # add your remote:path to serve at the end of following command!
    command: [ "serve", "restic" ]
    #command: [ "cleanup" ]
    volumes:
      - /opt/rclone/config:/config/rclone
      - /opt/rclone/htpasswd:/config/htpasswd:ro
    tmpfs:
      # default tmpfs opts: rw,nosuid,nodev,noexec,relatime,size=65536k
      - /tmp:rw,nosuid,nodev,noexec,relatime,size=65536k
      - /home/rclone/.cache/rclone:rw,nosuid,nodev,noexec,relatime,size=65536k
    networks:
      - rclone-front
    cpu_shares: 512
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          cpus: '2.0'  # number of cores
          memory: 384m
        reservations:
          memory: 64m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 10s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    read_only: true

  # https://restic.net/
  # On-demand container: external scheduling
  base-restic-client:
    image: restic/restic:${RESTIC_VERSION:-0.16.0}
    init: true
    labels:
      - "traefik.enable=false"
    environment:
      - GOMAXPROCS=2
      - RESTIC_PACK_SIZE=32M
      - RESTIC_CACHE_DIR=/srv/cache/restic
      - TMPDIR=/tmp
      #- RESTIC_REPOSITORY=rest:https://user:pass@restic.example.net/my-server/
      - RESTIC_PASSWORD_FILE=/opt/restic/password
      #- RESTIC_PROGRESS_FPS=0.016666
    user: root
    # fixed hostname to enable restic to find parent snapshot
    hostname: "restic-client"
    command: [ "backup", "-o", "rest.connections=2", "--no-scan", "--ignore-inode", "--exclude-caches", "--exclude", "**/.zfs", "--exclude", "**/.cache/**", "/mnt/server" ]
    #command: [ "unlock" ]
    #command: [ "forget", "--group-by", "paths", "--keep-within", "15d", "--max-unused", "15%", "--prune", "--cleanup-cache" ]
    #command: [ "check" ]
    #command: [ "cache", "--cleanup" ]
    #command: [ "snapshots" ]
    cap_add:
      - DAC_READ_SEARCH
    volumes:
      - /opt/restic:/opt/restic:ro
      - /srv/restic-cache:/srv/cache/restic
      - /home:/mnt/server/home:ro
      - /root:/mnt/server/root:ro
      - /usr/local:/mnt/server/usr/local:ro
      - /etc:/mnt/server/etc:ro
      - /opt:/mnt/server/opt:ro
      - /srv:/mnt/server/srv:ro
    tmpfs:
      # default tmpfs opts: rw,nosuid,nodev,noexec,relatime,size=65536k
      - /tmp:rw,nosuid,nodev,noexec,relatime,size=131072k
    #networks:
    #  - restic-back-internal
    cpu_shares: 512
    memswap_limit: 512m
    deploy:
      resources:
        limits:
          cpus: '2.0'  # number of cores
          memory: 384m
        reservations:
          memory: 64m
      restart_policy:
        condition: no  # no, on-failure[:max-retries], always, unless-stopped (default: no)
    read_only: true

  # usage: docker compose run --rm -e RESTIC_REPOSITORY=... base-restic-mount
  base-restic-mount:
    extends:
      service: base-restic-client
    command: [ "mount", "-o", "rest.connections=2", "/mnt/restic" ]
    cap_add:
      - SYS_ADMIN
      - MKNOD
    security_opt:
      - apparmor:unconfined
    volumes:
      - /mnt/restic:/mnt/restic:shared
      #- /etc/fuse.conf:/etc/fuse.conf:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    devices:
      - /dev/fuse

########################################################################

  # https://docs.newrelic.com/docs/release-notes/infrastructure-release-notes/infrastructure-agent-release-notes/
  newrelic-infrastructure:
    <<: *base-service
    image: newrelic/infrastructure
    init: false
    labels:
      - "traefik.enable=false"
    environment:
      # https://docs.newrelic.com/docs/infrastructure/install-infrastructure-agent/configuration/infrastructure-agent-configuration-settings/
      - NRIA_LICENSE_KEY=
      #- NRIA_DISPLAY_NAME=
      - NRIA_PAYLOAD_COMPRESSION_LEVEL=3
      - NRIA_DOCKER_API_VERSION=1.41
      - NRIA_ENABLE_PROCESS_METRICS=true
      - TINI_SUBREAPER=
    volumes:
      - /:/host:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /srv/newrelic/data:/var/db/newrelic-infra/data
      - /srv/newrelic/user_data:/var/db/newrelic-infra/user_data
    # https://docs.newrelic.com/docs/infrastructure/install-infrastructure-agent/manage-your-agent/infrastructure-agent-performance-overhead/
    healthcheck:
      test: if [ -z "$$(pgrep newrelic-infra)" ]; then echo "No newrelic-infra process!"; exit 1; else exit 0; fi
      interval: 240s
      timeout: 5s
      retries: 1
    cap_add:
      - SYS_PTRACE
    network_mode: "host"
    pid: "host"
    expose:
      - "8001"
    cpu_shares: 256
    memswap_limit: 96m
    deploy:
      resources:
        limits:
          memory: 64m
        reservations:
          memory: 32m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    privileged: true

  newrelic-php-daemon:
    <<: *base-service
    image: newrelic/php-daemon
    init: true
    labels:
      - "traefik.enable=false"
    #command: ["-c", "/etc/newrelic/newrelic.cfg", "--define", "utilization.detect_docker=true"]
    command: ["--define", "utilization.detect_docker=true", "--define", "app_timeout=24h"]
    #volumes:
    #  # https://docs.newrelic.com/docs/agents/php-agent/configuration/proxy-daemon-newreliccfg-settings/
    #  - /opt/newrelic-php-daemon/newrelic.cfg:/etc/newrelic/newrelic.cfg:ro
    healthcheck:
      test: if [ -z "$$(pgrep newrelic-daemon)" ]; then echo "No newrelic-daemon process!"; exit 1; else exit 0; fi
      interval: 240s
      timeout: 5s
      retries: 1
    depends_on:
      newrelic-infrastructure:
        condition: service_started
    networks:
      # "default" needed to get connectivity to outside
      - default
      - nextcloud-back-internal
      - ttrss-back-internal
      - wordpress-back-internal
    expose:
      - "31339"
    cpu_shares: 256
    memswap_limit: 64m
    deploy:
      resources:
        limits:
          memory: 48m
        reservations:
          memory: 24m
      restart_policy:
        condition: always  # no, on-failure[:max-retries], always, unless-stopped (default: no)
        delay: 5s  # (default: 0)
        window: 60s  # How long to wait before deciding if a restart has succeeded (default: decide immediately)
    #privileged: false

########################################################################
########################################################################

#volumes:
#    my-nfs-mount:
#        driver: local
#        driver_opts:
#            type: "nfs4"
#            o: "addr=192.0.2.111,ro"
#            #o: "addr=192.0.2.111,vers=4,soft,timeo=180,bg,tcp,ro"
#            device: ":/path/to/server/nfs/share"

########################################################################
########################################################################

networks:
  #default:
  #  enable_ipv6: false
  #  ipam:
  #    config:
  #      - subnet: 192.0.2.0/24
  #        # defining aux addresses prevents from assigning them to containers
  #        #aux_addresses:
  #        #  host1: 192.0.2.42
  #  driver_opts:
  #    com.docker.network.bridge.enable_icc: "false"
  #    com.docker.network.bridge.enable_ip_masquerade: "false"
  #  internal: true
  tomcat-front:
    ipam:
      config:
      - subnet: 172.31.1.0/24
  tomcat-back-internal:
    ipam:
      config:
        - subnet: 172.29.1.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  tomcat-back:
    ipam:
      config:
        - subnet: 172.30.1.0/24
  kavita-front:
    ipam:
      config:
        - subnet: 172.31.2.0/24
  kavita-back:
    ipam:
      config:
        - subnet: 172.30.2.0/24
  nextcloud-front:
    ipam:
      config:
        - subnet: 172.31.3.0/24
  nextcloud-back-internal:
    ipam:
      config:
        - subnet: 172.29.3.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  nextcloud-back:
    ipam:
      config:
        - subnet: 172.30.3.0/24
  ttrss-front:
    ipam:
      config:
        - subnet: 172.31.4.0/24
  ttrss-back-internal:
    ipam:
      config:
        - subnet: 172.29.4.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  ttrss-back:
    ipam:
      config:
        - subnet: 172.30.4.0/24
  wordpress-front:
    ipam:
      config:
        - subnet: 172.31.5.0/24
  wordpress-back-internal:
    ipam:
      config:
        - subnet: 172.29.5.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  wordpress-back:
    ipam:
      config:
        - subnet: 172.30.5.0/24
  tiddlywiki-front:
    ipam:
      config:
        - subnet: 172.31.7.0/24
  dovecot:
    ipam:
      config:
        - subnet: 172.31.8.0/24
  transmission:
    ipam:
      config:
        - subnet: 172.31.9.0/24
  icecast-front:
    ipam:
      config:
        - subnet: 172.31.10.0/24
  icecast-back-internal:
    ipam:
      config:
        - subnet: 172.29.10.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  vaultwarden:
    ipam:
      config:
        - subnet: 172.31.12.0/24
  http-static:
    ipam:
      config:
        - subnet: 172.31.13.0/24
  #daapd-front:
  #  ipam:
  #    config:
  #      - subnet: 172.31.14.0/24
#  daapd-front:
#    driver: macvlan
#    driver_opts:
#      parent: eth0
#      ipvlan_mode: l2
#    ipam:
#      config:
#        - subnet: 192.168.1.0/24
#          gateway: 192.168.1.254
#          ip_range: 192.168.1.128/31 # IP from this pool are assigned automatically
  webssh:
    ipam:
      config:
        - subnet: 172.31.15.0/24
  rclone-front:
    ipam:
      config:
        - subnet: 172.31.17.0/24
  vpn:
    ipam:
      config:
        - subnet: 172.31.53.0/24
          ip_range: 172.31.53.0/24
          gateway: 172.31.53.254
          # defining aux addresses prevents from assigning them to containers
          #aux_addresses:
          #  dns: 172.31.53.53
...
