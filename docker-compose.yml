%YAML 1.2
---
# https://docs.docker.com/compose/compose-file/
# https://hub.docker.com/explore/

version: '2.2'

services:

  dummy-service-for-yaml-reference:
    build: .
    links: &consul_link
    - consul:consul

  base-service:
    build: .
    expose:
    # Consul agent ports
    - "8301"
    - "8301/udp"
    #- "8400"
    #- "8500"
    #environment:
    # please note that SYSLOG requires read_only: false (as it needs creating /dev/log)
    #- ENABLE_SYSLOG=1
    #- ENABLE_CRON=1
    #- ENABLE_CONSUL=1
    tmpfs:
    # default tmpfs opts: rw,nosuid,nodev,noexec,relatime,size=65536k
    - /run:rw,nosuid,noexec,relatime,size=65536k,mode=755
    - /run/lock:rw,nosuid,nodev,noexec,relatime,size=5120k
    #- /var/log
    #- /var/cache
    - /tmp:rw,nosuid,nodev,noexec,size=131072k,mode=1777,strictatime
    # PHP.ini 'session.save_path'
    #- /var/lib/php/sessions
    # required for syslog
    #- /var/lib/syslog-ng:rw,nosuid,nodev,noexec,relatime,size=16k
    # required for logrotate
    - /var/lib/logrotate:rw,nosuid,nodev,noexec,relatime,size=16k
    # mount work dir for runit
    - /var/lib/runit-sv:rw,suid,nodev,exec,size=1024k
    # mount work dir for consul
    #- /usr/local/etc/consul.d:rw,nosuid,nodev,noexec,size=128k
    #shm_size: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "9"
    cpu_shares: 1024
    mem_limit: 128m
    memswap_limit: 192m
    mem_swappiness: 10
    #mem_reservation: 128m
    #read_only: true
    restart: "no"

########################################################################

  consul:
    extends:
      service: base-service
    build:
      context: consul
    expose:
    - "8300"
    - "8301"
    - "8301/udp"
    - "8302"
    - "8302/udp"
    - "8400"
    - "8500"
    - "8600"
    - "8600/udp"
    - "53"
    - "53/udp"
    environment:
    # See https://www.consul.io/docs/agent/options.html
    #- CONSUL_OPTS=-dev
    - CONSUL_OPTS=-bootstrap-expect 1 -datacenter dc1
    volumes:
    - /opt/consul/config:/usr/local/etc/consul:ro
    - /srv/consul/data:/srv/consul/data
    #- /lib/modules:/lib/modules:ro
    #cap_add:
    #- NET_ADMIN
    networks:
    # Consul can only work with 1 network interface... :-(
    #- tomcat-back-internal
    #- owncloud-back-internal
    #- prestashop-back-internal
    #- joomla-back-internal
    #- wordpress-back-internal
    #- dokuwiki-back-internal
    #- tiddlywiki-back-internal
    #- transmission
    #- netdata
    - vpn
    mem_limit: 128m
    memswap_limit: 192m
    mem_reservation: 64m
    read_only: true
    restart: always

########################################################################

  http-proxy:
    extends:
      service: base-service
    build: apache-proxy
    ports:
    - "80:80"
    - "443:443"
    #depends_on:
    #- tomcat
    #- owncloud
    #- prestashop
    #- wordpress
    #- dokuwiki
    #- tiddlywiki
    links:
    - tomcat:tomcat
    - owncloud:owncloud
    - prestashop:prestashop
    #- joomla:joomla
    - wordpress:wordpress
    - dokuwiki:dokuwiki
    - tiddlywiki:tiddlywiki
    - droppy:droppy
    - transmission:transmission
    #- netdata:netdata
    - portainer:portainer
    volumes:
    #- /opt/http-proxy/mods-available:/opt/http-proxy/mods-available:ro
    - /opt/http-proxy/mods-enabled:/opt/http-proxy/mods-enabled:ro
    #- /opt/http-proxy/conf-available:/opt/http-proxy/conf-available:ro
    - /opt/http-proxy/conf-enabled:/opt/http-proxy/conf-enabled:ro
    - /opt/http-proxy/conf-include:/opt/http-proxy/conf-include:ro
    #- /opt/http-proxy/sites-available:/opt/http-proxy/sites-available:ro
    - /opt/http-proxy/sites-enabled:/opt/http-proxy/sites-enabled:ro
    - /opt/http-proxy/tls:/opt/http-proxy/tls:ro
    #- /opt/letsencrypt:/opt/http-proxy/tls:ro
    - /srv/http-proxy:/var/www:ro
    - /srv/logs/http-proxy:/var/log
    networks:
    # "default" needed to get connectivity from outside(!)
    - default
    - tomcat-front
    - owncloud-front
    - prestashop-front
    - joomla-front
    - wordpress-front
    - dokuwiki-front
    - tiddlywiki-front
    - droppy
    - transmission
    - netdata
    cpu_shares: 256
    mem_limit: 128m
    memswap_limit: 192m
    mem_reservation: 96m
    read_only: true
    restart: unless-stopped

########################################################################

  portainer:
    image: portainer/portainer
    init: true
    #command: ["--tlsverify", "--tlscacert", "/certs/ca.pem", "--tlscert", "/certs/cert.pem", "--tlskey", "/certs/key.pem"]
    #command: ["--templates", "https://raw.githubusercontent.com/portainer/templates/master/templates.json"]
    command: ["--no-analytics"]
    expose:
    - "9000"
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - /srv/portainer/acme-challenge/.well-known:/.well-known
    #- /opt/portainer/certs:/certs
    - /srv/portainer/data:/data
    cpu_shares: 128
    mem_limit: 64m
    memswap_limit: 96m
    mem_reservation: 32m
    read_only: true
    restart: unless-stopped

########################################################################

  tomcat:
    extends:
      service: base-service
    build:
      context: tomcat
      args:
      - TOMCAT_VERSION=8.5.20
    expose:
    - "8080"
    - "8443"
    environment:
    - CATALINA_BASE=/opt/tomcat/my-instance
    depends_on:
      email-relay:
        condition: service_started
    links:
    - email-relay:email-relay
    volumes:
    - /opt/tomcat:/opt/tomcat
    - /srv/logs/tomcat:/var/log
    networks:
    - tomcat-front
    - tomcat-back-internal
    - tomcat-back
    mem_limit: 1024m
    memswap_limit: 1024m
    mem_swappiness: 1
    mem_reservation: 1024m
    read_only: true
    restart: on-failure:2

########################################################################

  owncloud:
    extends:
      service: base-service
    #image: owncloud:latest
    build:
      context: owncloud
      args:
      #- OWNCLOUD_VERSION=9.1
      - OWNCLOUD_VERSION=stable
    expose:
    - "80"
    - "443"
    environment:
    - ENABLE_CRON=1
    #- ENABLE_SYSLOG=1
    #- SERVER_NAME=https://www.example.com
    depends_on:
      redis-owncloud:
        condition: service_healthy
      email-relay:
        condition: service_started
    links:
    - mysql:mysql
    #- memcached-owncloud:memcached
    - redis-owncloud:redis
    - email-relay:email-relay
    volumes:
    - /srv/owncloud/acme-challenge/.well-known:/var/www/owncloud/.well-known
    - /opt/owncloud/config:/var/www/owncloud/config
    - /opt/owncloud/apps:/var/www/owncloud/apps2
    - /opt/owncloud/ip-restriction.conf:/etc/apache2/conf-enabled/ip-restriction.conf:ro
    - /srv/owncloud:/srv/owncloud
    - /srv/logs/owncloud:/var/log
    networks:
    - owncloud-front
    - owncloud-back-internal
    - owncloud-back
    mem_limit: 384m
    memswap_limit: 512m
    mem_reservation: 256m
    read_only: false
    restart: unless-stopped

########################################################################

  prestashop:
    extends:
      service: base-service
    #image: prestashop/prestashop:1.6
    build:
      context: prestashop
      args:
      - PRESTASHOP_VERSION=1.6.1.16
    expose:
    - "80"
    - "443"
    environment:
    - PS_FOLDER_ADMIN=admin
    - PS_FOLDER_INSTALL=install
    - PS_INSTALL_AUTO=0
    - DB_SERVER=mysql
    - DB_USER=
    - DB_PASSWD=
    #- DB_NAME=
    - PS_LANGUAGE=fr
    - PS_COUNTRY=fr
    - PS_TIMEZONE=Europe/Paris
    - PS_DOMAIN=www.example.com
    - ADMIN_FIRST_NAME=Admin
    - ADMIN_LAST_NAME=Istrator
    - ADMIN_MAIL=prestashop-admin@example.com
    - ADMIN_PASSWD=changeme
    - ADMIN_NEWSLETTER=0
    - ADMIN_SEND_EMAIL=1
    depends_on:
      mysql:
        condition: service_healthy
      email-relay:
        condition: service_started
    links:
    - mysql:mysql
    #- memcached-prestashop:memcached
    - email-relay:email-relay
    volumes:
    - /srv/prestashop/acme-challenge/.well-known:/var/www/html/.well-known
    - /srv/prestashop/htaccess:/var/www/html/.htaccess
    - /srv/prestashop/override:/var/www/html/override
    #- /srv/prestashop/mails:/var/www/html/mails
    # tous les dossiers du dossier /img, sauf /img/admin et /img/jquery-ui
    - /srv/prestashop/img:/var/www/html/img
    # Ne copiez que les modules que vous avez ajoutés depuis que vous avez installé PrestaShop la première fois (et qui ne font donc pas partie de l'installation par défaut).
    - /srv/prestashop/modules:/var/www/html/modules
    #- /srv/prestashop/themes/votreTheme:/var/www/html/themes/votreTheme
    # produits téléchargeables, les fichiers attachés, et les produits personnalisables
    - /srv/prestashop/download:/var/www/html/download
    - /srv/prestashop/upload:/var/www/html/upload
    - /srv/prestashop/config:/var/www/html/config
    #- /srv/prestashop/config/config.inc.php:/var/www/html/config/config.inc.php
    #- /srv/prestashop/config/defines.inc.php:/var/www/html/config/defines.inc.php
    #- /srv/prestashop/config/settings.inc.php:/var/www/html/config/settings.inc.php
    #- /srv/prestashop/config/smarty.config.inc.php:/var/www/html/config/smarty.config.inc.php
    #- /srv/prestashop/translations/myTranslation:/var/www/html/translations/myTranslation
    - /srv/prestashop/translations/fr:/var/www/html/translations/fr
    #- /srv/prestashop/admin-backups:/var/www/html/${PS_FOLDER_ADMIN}/backups/
    - /srv/logs/prestashop:/var/log
    networks:
    - prestashop-front
    - prestashop-back-internal
    - prestashop-back
    mem_limit: 448m
    memswap_limit: 512m
    mem_reservation: 416m
    read_only: false
    restart: unless-stopped

########################################################################

  joomla:
    extends:
      service: base-service
    #image: joomla:3.6-apache
    build:
      context: joomla
      args:
      - JOOMLA_VERSION=3.6.5
    expose:
    - "80"
    - "443"
    environment:
    - ENABLE_CRON=1
    #- ENABLE_SYSLOG=1
    #- JOOMLA_DB_HOST=mysql
    #- JOOMLA_DB_USER=
    #- JOOMLA_DB_PASSWORD=
    #- JOOMLA_DB_NAME=
    depends_on:
      mysql:
        condition: service_healthy
      email-relay:
        condition: service_started
    links:
    - mysql:mysql
    #- memcached-joomla:memcached
    - email-relay:email-relay
    volumes:
    - /srv/logs/joomla:/var/log
    - /srv/joomla:/var/www/html
    networks:
    - joomla-front
    - joomla-back-internal
    - joomla-back
    mem_limit: 384m
    memswap_limit: 512m
    read_only: false
    restart: on-failure:5

########################################################################

  wordpress:
    extends:
      service: base-service
    #image: wordpress:latest
    build:
      context: wordpress
      args:
      #- WORDPRESS_VERSION=wordpress-4.7.5
      - WORDPRESS_VERSION=latest
    expose:
    - "80"
    - "443"
    #environment:
    #- WORDPRESS_DB_HOST=mysql
    #- WORDPRESS_DB_USER=root
    #- WORDPRESS_DB_PASSWORD=
    #- WORDPRESS_DB_NAME=wordpress
    #- WORDPRESS_TABLE_PREFIX=
    # WordPress key generator: https://api.wordpress.org/secret-key/1.1/salt/
    #- WORDPRESS_AUTH_KEY=
    #- WORDPRESS_SECURE_AUTH_KEY=
    #- WORDPRESS_LOGGED_IN_KEY=
    #- WORDPRESS_NONCE_KEY=
    #- WORDPRESS_AUTH_SALT=
    #- WORDPRESS_SECURE_AUTH_SALT=
    #- WORDPRESS_LOGGED_IN_SALT=
    #- WORDPRESS_NONCE_SALT=
    depends_on:
      mysql:
        condition: service_healthy
      email-relay:
        condition: service_started
    links:
    - mysql:mysql
    #- memcached-wordpress:memcached
    - email-relay:email-relay
    volumes:
    - /srv/wordpress/acme-challenge/.well-known:/var/www/html/.well-known
    - /srv/wordpress/htaccess:/var/www/html/.htaccess
    - /srv/wordpress/wp-config.php:/var/www/html/wp-config.php
    - /srv/wordpress/wp-content:/var/www/html/wp-content
    - /srv/wordpress/wp-includes-languages:/var/www/html/wp-includes/languages
    - /srv/logs/wordpress:/var/log
    networks:
    - wordpress-front
    - wordpress-back-internal
    - wordpress-back
    mem_limit: 448m
    memswap_limit: 512m
    mem_reservation: 384m
    read_only: false
    restart: on-failure:5

########################################################################

  dokuwiki:
    extends:
      service: base-service
    build:
      context: dokuwiki
      args:
      #- DOKUWIKI_VERSION=2017-02-19b
      - DOKUWIKI_VERSION=stable
      # Languages to keep (delete all others)
      #- STRIP_LANGS_KEEP=en,fr
    expose:
    - "80"
    - "443"
    environment:
    - ENABLE_CRON=1
    depends_on:
      email-relay:
        condition: service_started
    links:
    - email-relay:email-relay
    volumes:
    - /srv/dokuwiki/acme-challenge/.well-known:/var/www/html/.well-known
    - /srv/dokuwiki/conf:/var/www/html/conf
    - /srv/dokuwiki/lib/plugins:/var/www/html/lib/plugins
    #- /srv/dokuwiki/lib/tpl:/var/www/html/lib/tpl
    - /srv/dokuwiki/data:/var/www/html/data
    - /srv/logs/dokuwiki:/var/log
    networks:
    - dokuwiki-front
    - dokuwiki-back-internal
    - dokuwiki-back
    mem_limit: 192m
    memswap_limit: 256m
    mem_reservation: 128m
    read_only: false
    restart: on-failure:5

########################################################################

  tiddlywiki:
    extends:
      service: base-service
    build:
      context: tiddlywiki
    expose:
    - "8080"
    environment:
    - WIKI_FOLDER=wiki
    - PORT=8080
    - USERNAME=
    - PASSWORD=
    - PATHPREFIX=
    volumes:
    - /srv/tiddlywiki:/srv
    networks:
    - tiddlywiki-front
    mem_limit: 384m
    memswap_limit: 512m
    mem_reservation: 256m
    read_only: true
    restart: on-failure:5

########################################################################

  # https://github.com/silverwind/droppy
  droppy:
    image: silverwind/droppy
    #image: silverwind/armhf-droppy
    init: true
    command: ["/usr/bin/droppy", "start", "--color", "-f", "/files", "-c", "/config"]
    expose:
    - "8989"
    #environment:
    #- UID=nobody
    #- GID=nogroup
    user: nobody:nogroup
    volumes:
    - /opt/droppy:/config
    - /srv/droppy:/files
    networks:
    - droppy
    healthcheck:
      test: wget -q -O /dev/null localhost:8989 || exit 1
      interval: 240s
      timeout: 5s
      retries: 1
    cpu_shares: 128
    mem_limit: 192m
    memswap_limit: 256m
    mem_reservation: 128m
    read_only: true
    restart: unless-stopped

########################################################################

  email-relay:
    extends:
      service: base-service
    build:
      context: email-relay
      args:
      - POSTFIX_HOSTNAME=myhost.example.net
    expose:
    - "25"
    environment:
    - ENABLE_SYSLOG=1
    - ENABLE_CRON=1
    volumes:
    - /opt/email-relay/dkim:/usr/local/etc/dkim:ro
    - /srv/logs/email-relay:/var/log
    networks:
    - tomcat-back
    - owncloud-back
    - prestashop-back
    - joomla-back
    - wordpress-back
    - dokuwiki-back
    cpu_shares: 128
    mem_limit: 64m
    memswap_limit: 96m
    mem_reservation: 32m
    read_only: false
    restart: always

########################################################################

  mysql:
    extends:
      service: base-service
    #image: mysql:5.7
    build:
      context: mysql
      args:
      #- MYSQL_VERSION=5.7
      - MYSQL_VERSION=${MYSQL_VERSION}
    expose:
    - "3306"
    environment:
    - ENABLE_CRON=1
    #- ENABLE_SYSLOG=1
    - MYSQL_ROOT_PASSWORD=
    #- MYSQL_CUSTOM_OPTS=--key_buffer_size=4M --sort_buffer_size=128K --read_buffer_size=64K --net_buffer_length=8K
    #- MYSQL_CUSTOM_OPTS=--innodb_buffer_pool_size=64M --innodb_log_buffer_size=8M
    #- MYSQL_CUSTOM_OPTS=--default-storage-engine=MyISAM --default_tmp_storage_engine=MyISAM
    #- MYSQL_CUSTOM_OPTS=--sql-mode=NO_ENGINE_SUBSTITUTION
    # http://bugs.mysql.com/bug.php?id=68287 [MySQL 5.6]
    # There are thresholds based on table_open_cache and table_definition_cache and max_connections and crossing the thresholds produces a big increase in RAM used. The thresholds work by first deciding if the server size is small, medium or large.
    # Small: all three are same as or less than defaults (2000, 400, 151). (max 52.6 megabytes RAM)
    # Large: any of the three is more than twice the default. (min 400 megabytes RAM)
    # Medium: others. (90.7-98.4 megabytes RAM)
    # default values: [MySQL 5.7]
    #   table_open_cache = 2000
    #   table_definition_cache = min(2000, 400 + (table_open_cache / 2))
    #   max_connections = 151
    # instead of turning off performance_schema, you can reduce RAM usage with --table_open_cache=400 --table_definition_cache=400 --max_connections=151
    - MYSQL_CUSTOM_OPTS=--performance_schema=off --table_definition_cache=800
    volumes:
    - /opt/mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
    #- /opt/mysql/conf.d:/etc/mysql/conf.d
    - /srv/mysql/data:/var/lib/mysql
    - /srv/mysql/backup:/srv
    - /srv/logs/mysql:/var/log
    networks:
    #- tomcat-back-internal
    - owncloud-back-internal
    - prestashop-back-internal
    - joomla-back-internal
    - wordpress-back-internal
    #ulimits:
    #  nproc: 65535
    #  nofile:
    #    soft: 20000
    #    hard: 40000
    #cpu_shares: 512
    mem_limit: 448m
    memswap_limit: 512m
    mem_reservation: 416m
    read_only: true
    restart: unless-stopped

########################################################################

  memcached:
    image: memcached:1.4-alpine
    init: true
    command: ["memcached", "-m", "64", "-p", "11211", "-c", "256"]
    expose:
    - "11211/tcp"
    - "11211/udp"
    healthcheck:
      test: if [ `pgrep -cx memcached` -eq 0 ]; then echo "No memcached process!"; exit 1; else exit 0; fi
      interval: 30s
      timeout: 5s
      retries: 1
    cpu_shares: 128
    mem_limit: 128m
    memswap_limit: 128m
    read_only: true
    restart: always

  memcached-prestashop:
    extends:
      service: memcached
    command: ["memcached", "-m", "96", "-p", "11211", "-c", "256"]
    networks:
    - prestashop-back-internal

  memcached-owncloud:
    extends:
      service: memcached
    command: ["memcached", "-m", "32", "-p", "11211", "-c", "256"]
    networks:
    - owncloud-back-internal

  memcached-joomla:
    extends:
      service: memcached
    command: ["memcached", "-m", "64", "-p", "11211", "-c", "256"]
    networks:
    - joomla-back-internal

  memcached-wordpress:
    extends:
      service: memcached
    command: ["memcached", "-m", "64", "-p", "11211", "-c", "256"]
    networks:
    - wordpress-back-internal

########################################################################

  redis:
    image: redis:3-alpine
    init: true
    command: ["--daemonize", "no", "--port", "6379", "--tcp-backlog", "511", "--loglevel", "notice", "--logfile", "", "--databases", "1", "--save", "900", "1", "--save", "300", "10", "--save", "60", "10000", "--stop-writes-on-bgsave-error", "yes", "--dbfilename", "dump.rdb", "--dir", "/data", "--maxclients", "100", "--maxmemory", "64mb", "--maxmemory-policy", "noeviction", "--slowlog-log-slower-than", "10000", "--slowlog-max-len", "128"]
    expose:
    - "6379"
    #volumes:
    #- /srv/redis:/data
    healthcheck:
      test: ping="$$(redis-cli --raw ping)" && [ "$$ping" = 'PONG' ] || exit 1
      interval: 30s
      timeout: 5s
      retries: 1
    #sysctls:
    #- sys.net.core.somaxconn=511
    #- vm.overcommit_memory=1
    #- sys.kernel.mm.transparent_hugepage.enabled=never
    cpu_shares: 128
    mem_limit: 128m
    memswap_limit: 128m
    mem_reservation: 80m
    read_only: true
    restart: always

  redis-owncloud:
    extends:
      service: redis
    command: ["--daemonize", "no", "--port", "6379", "--tcp-backlog", "511", "--loglevel", "notice", "--logfile", "", "--databases", "1", "--save", "900", "1", "--save", "300", "10", "--save", "60", "10000", "--stop-writes-on-bgsave-error", "yes", "--dbfilename", "dump.rdb", "--dir", "/data", "--maxclients", "100", "--maxmemory", "32mb", "--maxmemory-policy", "noeviction", "--slowlog-log-slower-than", "10000", "--slowlog-max-len", "128"]
    volumes:
    - /srv/redis-owncloud:/data
    networks:
    - owncloud-back-internal
    mem_reservation: 48m

########################################################################

  dovecot:
    extends:
      service: base-service
    build: dovecot-imap
    ports:
    # IMAP(s)
    #- "143:143"
    - "993:993"
    # POP3(s)
    #- "110:110"
    #- "995:995"
    # SMTP / submission / SMTPs
    #- "25:25"
    #- "587:587"
    #- "465:465"
    # Sieve
    #- "4190:4190"
    volumes:
    - /opt/dovecot:/opt/dovecot:ro
    - /srv/dovecot:/srv/dovecot
    - /srv/logs/dovecot:/var/log
    tmpfs:
    # this will have the side-effect of regenerating SSL parameters @ each startup
    - /var/lib/dovecot:rw,nosuid,nodev,noexec,size=32k
    networks:
    - dovecot
    cpu_shares: 256
    mem_limit: 128m
    memswap_limit: 192m
    mem_reservation: 96m
    read_only: true
    restart: unless-stopped

########################################################################

  # dnsmasq is our internal (since no ACL) DNS server
  dnsmasq-base:
    extends:
      service: base-service
    build: dnsmasq
    # Can not use "command: [...]" since we need to start runit as main process (dnsmasq is started via runit)
    #command: ["/usr/sbin/dnsmasq", "--log-facility=-", "--cache-size=150", "--no-hosts", "-H", "/opt/dnsmasq/hosts", "-r", "/opt/dnsmasq/resolv.conf", "--rebind-domain-ok=/plex.direct/gestionbbox.lan/"]
    expose:
    - "53/tcp"
    - "53/udp"
    environment:
    - ENABLE_CONSUL=1
    - CONSUL_NO_DNS_53=1
    # -log-facility=/dev/null
    # --log-queries --log-facility=-
    - DNSMASQ_EXTRA_OPTS=--cache-size=150 --log-facility=- --no-hosts -H /opt/dnsmasq/hosts -r /opt/dnsmasq/resolv.conf --rebind-domain-ok=/plex.direct/gestionbbox.lan/
    tmpfs:
    # mount writable dir for consul (configuration file built according to env vars)
    - /usr/local/etc/consul.d:rw,nosuid,nodev,noexec,size=128k
    cap_add:
    - NET_ADMIN
    #- NET_RAW already in base capabilities: https://github.com/docker/docker/blob/master/daemon/execdriver/native/template/default_template_linux.go#L16-L29
    cpu_shares: 128
    mem_limit: 192m
    memswap_limit: 256m
    mem_reservation: 160m
    read_only: true
    restart: always

  # dnsmasq is our internal (since no ACL) DNS server
  dnsmasq:
    extends:
      service: dnsmasq-base
    ports:
    # also publish service on gateway IP since docker-compose 1.6 can't assign a fixed IP to this container
    - "172.31.53.254:53:53/udp"
    environment:
    - DNSMASQ_EXTRA_OPTS=--cache-size=900 --log-facility=/dev/null --no-hosts -H /opt/dnsmasq/hosts -r /opt/dnsmasq/resolv.conf --rebind-domain-ok=/plex.direct/gestionbbox.lan/
    depends_on:
      consul:
        condition: service_healthy
    #  dnsmasq-shalla:
    #    condition: service_started
      dnsmasq-urlblacklist:
        condition: service_started
    links: *consul_link
    volumes:
    - /opt/dnsmasq:/opt/dnsmasq
    - /opt/dnsmasq/dnsmasq.d:/etc/dnsmasq.d:ro
    #- /srv/logs/dnsmasq:/var/log
    networks:
      vpn:
        ipv4_address: 172.31.53.53
    mem_limit: 96m
    memswap_limit: 128m
    mem_reservation: 96m

  dnsmasq-shalla:
    extends:
      service: dnsmasq-base
    environment:
    - CONSUL_TAG=shalla
    - DNSMASQ_EXTRA_OPTS=--cache-size=50 --log-facility=/dev/null --no-hosts -H /opt/dnsmasq/hosts -r /opt/dnsmasq/resolv.conf --rebind-domain-ok=/plex.direct/gestionbbox.lan/
    depends_on:
      consul:
        condition: service_healthy
      dnsmasq-urlblacklist:
        condition: service_started
    links: *consul_link
    volumes:
    - /opt/dnsmasq-shalla:/opt/dnsmasq
    - /opt/dnsmasq-shalla/dnsmasq.d:/etc/dnsmasq.d:ro
    #- /srv/logs/dnsmasq-shalla:/var/log
    networks:
    - vpn

  dnsmasq-urlblacklist:
    extends:
      service: dnsmasq-base
    environment:
    - CONSUL_TAG=urlblacklist
    - DNSMASQ_EXTRA_OPTS=--cache-size=50 --log-facility=/dev/null --no-hosts -H /opt/dnsmasq/hosts -r /opt/dnsmasq/resolv.conf --rebind-domain-ok=/plex.direct/gestionbbox.lan/
    depends_on:
      consul:
        condition: service_healthy
    links: *consul_link
    volumes:
    - /opt/dnsmasq-urlblacklist:/opt/dnsmasq
    - /opt/dnsmasq-urlblacklist/dnsmasq.d:/etc/dnsmasq.d:ro
#    - /srv/logs/dnsmasq-urlblacklist:/var/log
    networks:
    - vpn

  # Unbound is our external DNS gateway, with ACL
  unbound:
    extends:
      service: base-service
    build: unbound
    #ports:
    #- "192.0.2.1:53:53/tcp"
    #- "192.0.2.1:53:53/udp"
    environment:
    - ENABLE_CONSUL=1
    - CONSUL_NO_DNS_53=1
    depends_on:
      consul:
        condition: service_healthy
      dnsmasq:
        condition: service_started
    links: *consul_link
    dns:
    - 172.31.53.53
    volumes:
    - /opt/unbound:/etc/unbound/unbound.conf.d
    #- /srv/logs/unbound:/var/log
    tmpfs:
    # we need to write the Consul configuration file according to env vars
    - /usr/local/etc/consul.d:rw,nosuid,nodev,noexec,size=128k
    # for unbound autotrust file
    - /var/lib/unbound:rw,nosuid,nodev,noexec,size=128k
    networks:
    - vpn
    cpu_shares: 128
    mem_limit: 64m
    memswap_limit: 96m
    mem_reservation: 64m
    read_only: true
    restart: always

########################################################################

  web-accelerator:
    extends:
      service: base-service
    build: ziproxy
    expose:
    - "3128"
    dns:
    - 172.31.53.53
    #volumes:
    #- /srv/logs/ziproxy:/var/log
    networks:
      vpn:
        ipv4_address: 172.31.53.28
    cpu_shares: 128
    mem_limit: 128m
    memswap_limit: 192m
    mem_reservation: 32m
    read_only: true
    restart: unless-stopped

########################################################################

  openvpn:
    extends:
      service: base-service
    build:
      context: vpn-openvpn
      args:
      # stable|testing|release/2.3|release/2.4
      - OPENVPN_VERSION=stable
    #devices:
    #  - "/dev/net/tun:/dev/net/tun:rwm"
    ports:
    - "1194:1194/udp"
    #- "1194:1194/tcp"
    environment:
    #- PROTOCOL=udp
    #- DNS_USE_RESOLVCONF=true
    #- DNS_EXTRA_SERVER_1=172.31.53.254
    - DNS_EXTRA_SERVER_1=172.31.53.53
    #- DNS_EXTRA_SERVER_2=8.8.4.4
    # OpenVPN extra options
    #- OPENVPN_OPTS=
    # See https://github.com/OpenVPN/easy-rsa/blob/master/doc/EasyRSA-Advanced.md
    - EASYRSA_REQ_COUNTRY=US
    - EASYRSA_REQ_PROVINCE=California
    - EASYRSA_REQ_CITY=San Francisco
    - EASYRSA_REQ_ORG=Copyleft Certificate Co
    #- EASYRSA_REQ_EMAIL=me@example.net
    #- EASYRSA_REQ_OU=My Organizational Unit
    #- EASYRSA_KEY_SIZE=2048
    # CA expiration time in days
    #- EASYRSA_CA_EXPIRE=3650
    # issued cert expiration time in days
    #- EASYRSA_CERT_EXPIRE=3650
    #- EASYRSA_REQ_CN=ChangeMe
    #- EASYRSA_BATCH=
    depends_on:
      dnsmasq:
        condition: service_started
      web-accelerator:
        condition: service_started
    dns:
    - 172.31.53.53
    # use service on gateway IP since docker-compose 1.6 can't assign a fixed IP to dns container
    #- 172.31.53.254
    volumes:
    - /opt/openvpn:/etc/openvpn
    # Required for `modprobe tun`
    - /lib/modules:/lib/modules:ro
    #- /srv/logs/openvpn:/var/log
    tmpfs:
    # required to have the container read-only
    - /dev/net:rw,nosuid,dev,noexec,relatime,size=16k
    #- /var/log
    cap_add:
    - NET_ADMIN
    networks:
    - vpn
    sysctls:
    - net.ipv4.ip_forward=1
    - net.ipv4.conf.all.send_redirects=0
    - net.ipv6.conf.default.forwarding=1
    - net.ipv6.conf.all.forwarding=1
    cpu_shares: 128
    mem_limit: 64m
    memswap_limit: 96m
    mem_reservation: 32m
    read_only: true
    restart: unless-stopped

########################################################################

  transmission:
    extends:
      service: base-service
    build:
      context: transmission
    expose:
    - "9091"
    ports:
    - "51413:51413/tcp"
    - "51413:51413/udp"
    volumes:
    - /srv/transmission:/var/lib/transmission-daemon
    networks:
    - transmission
    #sysctls:
    #- net.core.rmem_max=4194304
    #- net.core.wmem_max=1048576
    cpu_shares: 64
    mem_limit: 128m
    memswap_limit: 192m
    mem_reservation: 96m
    #blkio-weight: 10
    read_only: true
    restart: "no"

########################################################################

  letsencrypt:
    extends:
      service: base-service
    image: quay.io/letsencrypt/letsencrypt:latest
    #build: letsencrypt
    command: --authenticators
    #ports:
    #- "80:80"
    #- "443:443"
    volumes:
    - /opt/letsencrypt:/etc/letsencrypt
    - /srv/letsencrypt:/var/lib/letsencrypt
    - /srv/logs/letsencrypt:/var/log
    # webroot authentification lets encrypt
    - /srv/owncloud/acme-challenge:/srv/owncloud/acme-challenge
    - /srv/prestashop/acme-challenge:/srv/prestashop/acme-challenge
    - /srv/joomla/.well-known:/srv/joomla/.well-known
    - /srv/wordpress/acme-challenge:/srv/wordpress/acme-challenge
    - /srv/droppy/.well-known:/srv/droppy/.well-known
    - /srv/dokuwiki/acme-challenge:/srv/dokuwiki/acme-challenge
    - /opt/tomcat/instance-cedrik/webapps/cedrik.fr/ROOT/.well-known:/opt/tomcat/instance-cedrik/webapps/cedrik.fr/ROOT/.well-known
    - /srv/portainer/acme-challenge:/srv/portainer/acme-challenge
    - /srv/http-proxy/polycarpe.fr/.well-known:/srv/http-proxy/polycarpe.fr/.well-known
    - /srv/http-proxy/vingt-citadelles.fr/.well-known:/srv/http-proxy/vingt-citadelles.fr/.well-known
    - /srv/http-proxy/html/.well-known:/srv/http-proxy/html/.well-known
    #networks:
    #- default
    logging:
      driver: "none"
    read_only: false
    restart: "no"

########################################################################

  netdata:
    extends:
      service: base-service
    build: netdata
    expose:
    - "19999"
    volumes:
    - /proc:/mnt/proc:ro
    - /sys:/mnt/sys:ro
    - /opt/netdata:/etc/netdata:ro
    #- /srv/logs/netdata:/var/log
    cap_add:
    - SYS_PTRACE
    networks:
    - netdata
    cpu_shares: 128
    mem_limit: 128m
    memswap_limit: 192m
    read_only: false
    restart: unless-stopped

########################################################################
########################################################################

#volumes:

########################################################################
########################################################################

networks:
  #default:
  #  driver_opts:
  #    com.docker.network.bridge.enable_icc: "false"
  #    com.docker.network.bridge.enable_ip_masquerade: "false"
  #    com.docker.network.enable_ipv6: "false"
  tomcat-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.1.0/24
  tomcat-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.1.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  tomcat-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.1.0/24
  owncloud-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.2.0/24
  owncloud-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.2.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  owncloud-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.2.0/24
  prestashop-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.3.0/24
  prestashop-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.3.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  prestashop-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.3.0/24
  joomla-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.4.0/24
  joomla-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.4.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  joomla-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.4.0/24
  wordpress-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.5.0/24
  wordpress-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.5.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  wordpress-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.5.0/24
  dokuwiki-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.6.0/24
  dokuwiki-back-internal:
    driver: bridge
    ipam:
      config:
      - subnet: 172.29.6.0/24
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
    internal: true
  dokuwiki-back:
    driver: bridge
    ipam:
      config:
      - subnet: 172.30.6.0/24
  tiddlywiki-front:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.7.0/24
  dovecot:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.8.0/24
  transmission:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.9.0/24
  netdata:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.10.0/24
  droppy:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.11.0/24
  vpn:
    driver: bridge
    ipam:
      config:
      - subnet: 172.31.53.0/24
        ip_range: 172.31.53.0/24
        gateway: 172.31.53.254
        # defining aux addresses prevents from assigning them to containers
        #aux_addresses:
        #  dns: 172.31.53.53
...
